(function(){var t=$("#speed-test-applet"),a=$("#speedtestSWF"),g=$("#speedtestEmbbeded"),s=RAINIER.ui.strings.speedtest,y=t.find("#serverSelection"),f=[],x="lastSpeedtestServerID",l="-1",i=l,q=l;var b={onClose:function(){RAINIER.ui.MainMenu.closeApplet()},onServerSelected:function(){y.find("> li").removeClass("selected");$(this).addClass("selected");q=$(this).attr("id")}};function r(){var z=$.cookie("ui-language");if(!z){z="en"}if(z.indexOf("-")!==-1){z=z.substr(0,z.indexOf("-"))}return"https://linksysconnect.speedtest.net/?bg=4&lang="+z}function d(z){var C=!z?$("#speed-test-unsupported-offline"):$("#speed-test-unsupported-remotely"),B,A={parent:$("#generic-dialog-wrapper"),dlgClass:"generic-dialog",onClose:function(){RAINIER.ui.MainMenu.closeApplet()}};B=RAINIER.ui.dialog(C,A);B.show()}function k(z){var A=$("#speed-test-error");if(z==="ErrorHealthCheckAlreadyRunning"){A=$("#speed-test-busy")}A.find(".close").unbind("click").click(function(){A.hide()});g.find("#speedtestStep").hide();g.find("#speedtestActionDesc").hide();A.show();o("error");g.find("#start-speedtest, #speedtestChangeWrapper").show()}function v(){var z=RAINIER.network.isBehindNode()?"node":"router";t.find(".error-herald").hide();g.find("#speedtestStart, #speedtestResults, #speedtestChangeWrapper, .result-ui").hide();o("ping");g.find("#speedtestStep").text(s.ping.action).show();g.find("#speedtestActionDesc").text(s.ping.description[z]).show();g.find(".divider, .speedtestGraphics, .pingAnimation, .speedtestRunning").show();if(q===l){g.find("#speedtestServer, #speedtestSponsor").hide()}symmetryUtil.monitors.healthCheck.start("SpeedTest",e,k,{timeout:35000,retry:1},{serverID:q})}function o(A){var z=g.find(".divider");z.removeClass("ping download upload error");z.find("#dot-line2 span").addClass("animate");if(A==="ping"){z.addClass("ping")}else{if(A==="download"){z.find("#dot-line2 span:nth-child(8)").removeClass("animate");z.addClass("download")}else{if(A==="upload"){z.find("#dot-line2 span:nth-child(1)").removeClass("animate");setTimeout(function(){z.addClass("upload")},10)}else{z.addClass("error")}}}}function m(B){var A=RAINIER.ui.strings.speedtest.results,z;if(B>A.optimal.downloadBandwidth){z=A.ultra.description}else{if(B>A.fast.downloadBandwidth){z=A.optimal.description}else{if(B>A.good.downloadBandwidth){z=A.fast.description}else{if(B>A.ok.downloadBandwidth){z=A.good.description}else{z=A.ok.description}}}}return z}function p(A){var D=g.find("#speedtestStep"),C=g.find("#speedtestActionDesc"),B=g.find("#speedtestResults");var z={ping:A.latency,downstreamBandwidth:(A.downloadBandwidth/1000).toFixed(1),upstreamBandwidth:(A.uploadBandwidth/1000).toFixed(1),description:m(A.downloadBandwidth/1000)};D.hide();C.hide();g.find(".speedtestGraphics, .speedtestRunning").hide();RAINIER.binder.toDom(z,g,{});B.show();g.find(".result-ui").show();if(RAINIER.network.isHealthChecker2Supported()){g.find("#speedtestChangeWrapper").show();if(f.length){j(false,A.serverID)}}}function h(){symmetryUtil.monitors.healthCheck.getResults("SpeedTest",1).success(function(A){if(A.result==="OK"){var B=lodash.result(A,"output.healthCheckResults"),z=lodash.find(B,"speedTestResult");if(z){p(lodash.result(z,"speedTestResult"))}else{g.find("#speedtestStart").show();g.find("#start-speedtest").show()}if(RAINIER.network.isHealthChecker2Supported()){g.find("#speedtestServerWrapper").show()}else{RAINIER.event.fire("applet.loaded")}}})}function e(z){var E=g.find("#speedtestStep"),D=g.find("#speedtestActionDesc"),A=g.find("#speedtestResults");function C(F){p(F.output.healthCheckResults[0].speedTestResult)}if(z.allStepsDone){setTimeout(function(){symmetryUtil.monitors.healthCheck.getResults("SpeedTest",1).success(C).error(k)},5000)}else{var B=RAINIER.network.isBehindNode()?"node":"router";switch(z.stepNumber){case 1:break;case 2:E.text(s.download.action);D.text(s.download.description[B]);o("download");break;case 3:E.text(s.upload.action);D.text(s.upload.description[B]);o("upload");break;default:k()}}}function w(){y.find("> li").removeClass("selected");y.find('li[id="'+i+'"]').addClass("selected")}function n(z){return lodash.find(f,{serverID:z})}function j(C,B){var z=B||q,A=n(z);if(z===l){g.find("#speedtestServer").hide();g.find("#speedtestSponsor").hide()}else{g.find("#speedtestServer").text(A.serverLocation);g.find("#speedtestSponsor").text(A.serverName);g.find("#speedtestServer, #speedtestSponsor, #speedtestServerWrapper").show()}if(C){RAINIER.deviceManager.getAuthorityDevice(function(D){D.setCustomProperty(x,q)})}}function c(){var A;function z(D){var C=lodash.result(D,"serverName")?"{serverLocation} - {serverName}":"{serverLocation}",B=('<li id="{serverID}">'+C+"</li>").formatObj(D);A=$(B);A.attr("tooltip",C.formatObj(D));RAINIER.ui.tooltip.add(A);A.click(b.onServerSelected);if(D.serverID===q){A.addClass("selected")}y.append(A)}f=[];y.text("");RAINIER.jnap.send({action:"/jnap/healthcheck/GetCloseHealthCheckServers",data:{},cb:function(C){if(C.result==="OK"){f=lodash.result(C,"output.healthCheckServers",[]);f.unshift({serverID:l,serverLocation:RAINIER.ui.strings.speedtest.optimal,});if(!n(q)){q=l}for(var B=0;B<f.length;B++){z(f[B])}j()}else{k()}RAINIER.event.fire("applet.loaded")},disableDefaultJnapErrHandler:true,disableDefaultAjaxErrHandler:true})}function u(z){if(RAINIER.network.isHealthChecker2Supported()){RAINIER.ui.showMasterWaiting()}t.find("footer .cancel").click(b.onClose);if(RAINIER.network.isHealthCheckerSupported()){t.find(".embeddedSupported").show();RAINIER.deviceManager.getAuthorityDevice(function(C){var A,B=RAINIER.ui.getDeviceIcon(C);i=q=C.getCustomProperty(x)||l;g.find("#start-speedtest").unbind("click").click(function(){v()});if(RAINIER.network.isHealthChecker2Supported()){g.find("#speedtestChangeServer").unbind("click").click(function(){g.find("#folding-wrapper").addClass("expand")});g.find(".cancel-server").unbind("click").click(function(){q=i;g.find("#folding-wrapper").removeClass("expand");w()});g.find(".save-server").unbind("click").click(function(){i=q;g.find("#folding-wrapper").removeClass("expand");j(true)});c()}else{g.find("#speedtestChangeServer").hide()}if(RAINIER.network.isBehindNode()){A=C.friendlyName()}else{A=C.modelNumber()}g.find(".device > label").text(A);g.show();h()})}else{t.find(".embeddedNotSupported").show();if(!z||RAINIER.network.isAuthorityRemote()){d(z)}else{a.attr("src",r());t.find("#speedtestSWF").css("display","inline")}RAINIER.event.fire("applet.loaded")}}RAINIER.network.checkInternetConnection(u)}());