(function(){var d,al=null,n=null,e=null,m=null,G=null,E=null,V="urn:cisco-com:ui:qos-order",ar="not set";var y={type:{device:"device",application:"application",onlineGame:"onlineGame"},priority:{low:"Low",normal:"Normal",medium:"Medium",high:"High"},trafficType:{background:"Background",generic:"Generic",voice:"Voice",video:"Video"}};var b={portRangeError:RAINIER.ui.validation.strings.security.portRangeError,portRangesOverlapSameApp:RAINIER.ui.validation.strings.mediaPrioritization.portRangeOverlapsWithThisApplication,portRangesOverlapOtherApp:RAINIER.ui.validation.strings.mediaPrioritization.portRangeOverlapsWithAnotherApplication,errorAppExists:RAINIER.ui.validation.strings.errors.ErrorApplicationExists,confirmDeleteApp:RAINIER.ui.strings.mediaPrioritization.confirmDeleteApplication,TCP:RAINIER.ui.common.strings.ipProtocol.TCP,UDP:RAINIER.ui.common.strings.ipProtocol.UDP,Both:RAINIER.ui.common.strings.ipProtocol.BothTCPAndUDP};var D=$("#media-pri-applet"),S=$("#isQoSEnabled"),c=D.find("#high-priority-group"),I=c.find(".list"),q=D.find("#normal-priority-group"),s=q.find("#normal-priority-devices"),t=q.find("#app-header"),H=t.find("a.edit"),R=t.find("a.delete"),A=q.find("#app-devices-container"),ai=A.find("#app-devices"),U=A.find("select"),r=q.find("#game-header"),af=r.find("a.edit"),Q=r.find("a.delete"),k=q.find("#game-devices-container"),j=k.find("#game-devices"),T=k.find("select");var ao=D.find("#device-templates").html(),F=D.find(".option-templates .empty").outerHtml();var u={high:"high",device:"device",application:"application",game:"game"};var ak="online-game",p="application",aa="urn:cisco-com:ui:qos";var N={mobileGaming:false,videoCalls:false};var o={onClose:function(){if(e){E.click();e=null}else{RAINIER.ui.MainMenu.closeApplet()}}};var au={"QoSSettings.isBandwidthAuto":"boolean","QoSSettings.isQoSEnabled":"boolean","WLANQoSSettings.isWMMEnabled":"boolean","WLANQoSSettings.isWirelessAcknowledgementDisabled":"boolean","QoSSettings.downstreamBandwidthbps":"number","QoSSettings.upstreamBandwidthbps":"number","LVVPSettings.isEnabled":"boolean"},w={QoSSettings:{},LVVPSettings:{}},ag={QoSSettings:{},LVVPSettings:{}};var at={setQoS:function ap(aw,ax,av){aw.add({action:RAINIER.jnapActions.setQoSSettings(),data:ax,cb:function(ay){if(ay.result==="OK"){if(av){av()}}else{console.warn("SetQoSSettings: o.output is empty. Terminating...error:"+ay.error+" result: "+ay.result)}}});if(N.videoCalls&&ax.isQoSEnabled&&w.LVVPSettings.isEnabled){ag.LVVPSettings.isEnabled=false;aw.add({action:"/jnap/lvvp/SetLVVPSettings",data:ag.LVVPSettings,cb:function(ay){if(ay.result==="OK"){$.extend(true,w.LVVPSettings,ag.LVVPSettings);v()}}})}},setWLANQoSSettings:function L(aw,ax,av){if(RAINIER.network.isQoSSupported()){aw.add({action:"/jnap/qos/SetWLANQoSSettings",data:ax,cb:function(ay){if(ay.result==="OK"){if(av){av()}}else{console.warn("SetWLANQoSSettings: o.output is empty. Terminating...error:"+ay.error+" result: "+ay.result)}}})}},resetQoS:function h(av){var aw={isQoSEnabled:false,isQoSAutoPrioritizingEnabled:ag.QoSSettings.isQoSAutoPrioritizingEnabled,upstreamBandwidthbps:0,downstreamBandwidthbps:0,deviceRules:[],applicationRules:[]};var ax={isWMMEnabled:true,isWirelessAcknowledgementEnabled:true};function ay(){RAINIER.deviceManager.getAuthorityDevice(function(aA){aA.removeCustomProperty(V);aA.removeCustomProperty("lastBandwidthCalibrationDate");aA.removeCustomProperty("bandwidthSpeedSetBy")});aw=d.filterJnapData(aw);var az=RAINIER.jnap.Transaction({onComplete:av});at.setQoS(az,aw);at.setWLANQoSSettings(az,ax);az.send()}RAINIER.deviceManager.getDevices({threshold:-1,exclusions:{excludeAuthority:true,excludeNodes:true},cb:function(az){var aB=[],aA=0;$.each(az,function(){if(!this.isGuest()&&!RAINIER.util.isNoE(this.getCustomProperty(aa))){aB.push(this)}});if(aB.length>0){aA=aB.length;$.each(aB,function(){console.warn(['Clearing "{0}" property from {1}'.format(aa,this.friendlyName())]);this.removeCustomProperty(aa,function(){aA--;if(aA===0){ay()}})})}else{ay()}}})}};I.data({list:u.high});s.data({list:u.device});ai.data({list:u.application});j.data({list:u.game});function X(av,ay,az,aw){aw=!!aw;var ax=av.find('option[value="'+ay.value+'"]');if(!ax.length&&az){ax=av.find('option[value="'+az+'"]')}if(!ax.length){av.find("option:last").before($("<option></option>").data(ay).prop("value",ay.value).text(ay.description));if(!aw){av.find('option[value="'+ay.value+'"]').prop("selected","selected");av.change()}}else{ax.prop("value",ay.value);ax.text(ay.description);ax.data(ay);if(!aw){ax.prop("selected","selected");av.change()}}}function l(av,ax){var aw=av.find('option[value="'+ax+'"]');av.val("none");if(aw.length){aw.remove()}av.change()}function ad(aw,aA){var az=aw.value,ay='li:[name="'+az+'"]'+(aA?',li:[name="'+aA+'"]':""),av=I.add(ai).add(j).find(ay),ax;av.each(function(aB,aC){ax=$(aC);ax.attr("name",az);ax.find("h3").text(unescape(az));ax.data(aw)})}function aj(aw,av){var ax=false;I.find("li").each(function(ay,az){if(aw===$(az).data("description")){ax=true}});if(av){$.each([U,T],function(ay,az){if(az.find('option[value="'+escape(aw)+'"]').length){ax=true}})}return ax}function O(av){if(!av.hasOwnProperty("lastPort")||av.lastPort===""){av.lastPort=av.firstPort}}function ah(aw){for(var av=0;av<aw.length;av++){for(var ax=0;ax<aw[av].portRanges.length;ax++){O(aw[av].portRanges[ax])}}}var ae=(function(){var aD=false,aM;I.find("li").each(function(){$(this).data({mediaType:y.type.device})});s.find("li").each(function(){$(this).data({mediaType:y.type.device})});ai.find("li").each(function(){$(this).data({mediaType:y.type.application})});j.find("li").each(function(){$(this).data({mediaType:y.type.onlineGame})});var ay="disabled";var aI,aA;function aB(aN){q.toggleClass(ay,!aN);c.toggleClass(ay,!aN);U.prop(ay,!aN);T.prop(ay,!aN);D.find("#drag-n-drop-arrows").toggleClass(ay,!aN);aK(aN);av(aN);aL(aN);RAINIER.ui.shield.toggle(D.find(".bucket"),!aN);D.find(".ui-sortable").sortable("refresh")}function aC(aN){c.toggleClass(ay,!aN);I.sortable(aN?"enable":"disable");I.sortable("refresh")}function aK(aN){s.toggleClass(ay,!aN);s.sortable(aN?"enable":"disable");s.sortable("refresh")}function av(aN){t.toggleClass(ay,!aN);U.prop(ay,!aN);ai.toggleClass(ay,!aN);ai.sortable(aN?"enable":"disable");ai.sortable("refresh")}function aL(aN){r.toggleClass(ay,!aN);T.prop(ay,!aN);j.toggleClass(ay,!aN);j.sortable(aN?"enable":"disable");j.sortable("refresh")}function ax(aN){c.toggleClass("highlight",aN===u.high);s.toggleClass("highlight",aN===u.device);ai.toggleClass("highlight",aN===u.application);j.toggleClass("highlight",aN===u.game)}S.change(function(){var aN=S.is(":checked");ag.QoSSettings.isQoSEnabled=aN;if(N.mobileGaming&&!ag.QoSSettings.isQoSEnabled&&w.QoSSettings.isQoSEnabled){D.find(".applet-button-section .submit").prop("disabled",false)}aB(aN)});function az(aP,aQ){var aO=$(this),aN=$(aQ.item);aD=true;aM=$(".ui-sortable-helper");aN.data("sourceList",aO.data("list"))}function aw(aQ,aR){if(!S.is(":checked")){return}var aP=$(this),aS=aP.data("list"),aO=$(aR.item),aN=aO.data("mediaType");q.removeClass(ay);c.removeClass(ay);switch(aS){case u.high:aC(true);break;case u.device:aK(aN===y.type.device);break;case u.application:av(aN===y.type.application);break;case u.game:aL(aN===y.type.onlineGame);break}}function aF(aQ,aS){var aP=$(this),aT=aP.data("list"),aO=$(aS.item),aR=aO.data(),aN=aR.mediaType;if(aN===y.type.application){if(aT===u.application){U.val(aR.value);U.change()}}else{if(aN===y.type.onlineGame){if(aT===u.game){T.val(aR.value);U.change()}}else{if(aN===y.type.device){aR.userPrioritized=true;aO.data(aR)}}}}function aE(){var aN=I.find("li");aD=false;aM.removeClass("invalid");aM=null;ax("none");function aO(aQ,aP){if(aP===y.type.application){ai.empty();ai.prepend(aQ);U.val(aQ.data("value"))}else{if(aP===y.type.onlineGame){j.empty();j.prepend(aQ);T.val(aQ.data("value"))}}}if(aN.length<3&&aI){I.append(aI)}else{if(aI){aO(aI,aA)}}if(N.mobileGaming){D.find(".applet-button-section .submit").prop("disabled",aN.length===0)}ai.removeClass("active");j.removeClass("active");$(".list li").each(function(aP,aQ){aQ.removeAttribute("style")});aI=null;aA=null;aB(true)}function aH(aR,aT){var aQ=$(this),aU=aQ.data("list"),aP=I.find("li"),aO=$(aT.item),aS=aO.data(),aN=aS.mediaType;ax(aU);if(aP.length<3&&aI){I.append(aI);aI=null;aA=null}if(aN===y.type.application){if(aU===u.application){if(ai.children.length>1){ai.find("li:not(.ui-sortable-placeholder)").remove()}}}else{if(aN===y.type.onlineGame){if(aU===u.game){if(j.children.length>1){j.find("li:not(.ui-sortable-placeholder)").remove()}}}}}function aJ(aQ,aR){var aP=$(this),aT=aP.data("list"),aO=I.find("li"),aN=$(aR.item),aS=aN.data("sourceList");if(aS!==u.high||aT!==u.high){if(aO.length>3){if(!aI){aI=I.find("li:not(.ui-sortable-placeholder):last");aA=aI.data("mediaType")}if(aA===y.type.device){s.prepend(aI)}else{if(aA===y.type.application){aI=aI.detach()}else{if(aA===y.type.onlineGame){aI=aI.detach()}}}}}}function aG(){D.find(".ui-sortable").sortable({containment:"article#media-pri-applet > section",activeClass:"ui-state-hover",hoverClass:"ui-state-active",tolerance:"intersect",revert:true,connectWith:"ul.list",start:az,activate:aw,stop:aE,over:aH,receive:aF,sort:aJ});D.find(".ui-sortable").disableSelection();ai.sortable("option","cursorAt",{right:10});ai.sortable("refresh");j.sortable("option","cursorAt",{right:10});j.sortable("refresh")}return{init:aG}}());var x=$("#reset-media-pri"),aq=$("#edit-media-pri-settings"),a,P;var B=(function(){var aA=D.find("#custom-application-dialog"),aG=aA.find("#portRanges-list"),aC=RAINIER.ui.buildInputValidBalloon,aD=RAINIER.ui.validation.tests,aw={},aR={validationType:"utf8LengthTooLong",whiteSpace:true,isRequired:true},aP={validCharSet:"numeric",minLen:0,minVal:1,maxVal:65535,whiteSpace:false,isBlankOkOnBlur:true},az,aM,aK,av,aE;function aO(aV,aT){var aU=aV.val(),aS;if(aU===""&&aT===""){return true}else{if($.isNumeric(aU)&&$.isNumeric(aT)){aU=parseInt(aU,10);aS=parseInt(aT,10);if(aU<=aS){return true}}}return false}function aF(aW,aS){var aU=aW.find('input:[name="firstPort"]'),aT=aW.find('input:[name="lastPort"]'),aV={};aV.firstPort=aC($.extend(true,{},aP,{isRequired:(aS===0),els:aU,group:"media"}));aV.lastPort=aC($.extend(true,{},aP,{isRequired:(aS===0),els:aT,errors:[{test:aO.curry(aU),when:false,message:b.portRangeError}],group:"media"}));aW.data({checks:aV})}function aN(){aR.maxLen=w.QoSSettings.maxDescriptionLength;aw.name=aC($.extend(true,{},aR,{els:aA.find('input:[name="description"]'),group:"media"}));aw.rangesOverlapp=RAINIER.ui.inputBalloon.add({isComposite:true,els:aA.find('input:[name="firstPort"], input:[name="lastPort"]'),elContainer:aA.find('input:[name="description"]'),errors:[{test:function(){return false},when:true,message:""}],isRequired:false})}function ay(aS){while(aS.length<3){aS.push({protocol:"Both",firstPort:"",lastPort:""})}}function aI(aS){for(var aT=aS.length-1;aT>=0;aT--){if(aS[aT].firstPort===""){aS[aT].firstPort=-1}O(aS[aT]);aS[aT].firstPort=parseInt(aS[aT].firstPort,10);aS[aT].lastPort=parseInt(aS[aT].lastPort,10);aS[aT].rowIndex=aT+1;if(aS[aT].firstPort===-1&&aS[aT].lastPort===-1){aS.splice(aT,1)}}}function aQ(aV,aU,aT){var aS;az=aT;aK=aU;av=aV;aM={};Y.refreshStoreFromDom();aA.removeClass("add-app edit-app add-game edit-game").addClass(aV+"-"+aU);if(aV==="edit"){aS=aT.find(":selected").data();if(!aS.portRanges){return}}else{aS={id:"",description:"",portRanges:[]}}ay(aS.portRanges);aM=$.extend({},aS);aG.empty();RAINIER.binder.toDom(aS,aA,au);RAINIER.binder.toDom(aS,$("#application-template"),au,aG);RAINIER.ui.validation.removeInvalidMarks(aA);RAINIER.ui.inputBalloon.reset("media");$("#portRanges-list tr").each(function(aW,aX){aF($(aX),aW)});aE.show()}function ax(aT){var aS=aT.data("checks");return aS.firstPort.isValid(true)&&aS.lastPort.isValid(true)}function aJ(){var aS=aw.name.isValid(true),aY,a3=0,aW,aT,aX,aZ,aU;if(aS){$("#portRanges-list tr").each(function(a4,a5){a3=a4;aS=ax($(a5));if(!aS){return aS}})}if(aS){$("#custom-application-dialog").each(function(a4,a5){if($(a5).parents("dialog-cache").length===0){aY=$(a5)}});aW=RAINIER.binder.fromDom(aY,au);if(av!=="edit"||aM.description!==aW.description){if(aj(aW.description,true)){aw.name.message({"class":"icon warning",message:b.errorAppExists});aS=false}}}if(aS){aT=aW.portRanges||[];aI(aT);for(aX=0,aZ=aT.length;aX<aZ;aX++){for(aU=aX+1;aU<aZ;aU++){if(aU!==aX&&aS){if(!((aT[aX].protocol==="UDP"&&aT[aU].protocol==="TCP")||(aT[aX].protocol==="TCP"&&aT[aU].protocol==="UDP"))){if(aD.doesRangeOverlap(aT[aX].firstPort,aT[aX].lastPort,aT[aU].firstPort,aT[aU].lastPort)){aw.rangesOverlapp.elContainer=$("#portRanges-list tr:nth-of-type("+aT[aX].rowIndex+")");aw.rangesOverlapp.message({"class":"icon warning",message:b.portRangesOverlapSameApp.format(aT[aU].firstPort,aT[aU].lastPort,b[aT[aU].protocol])});aS=false;break}}}}}}if(aS){var aV=ag.QoSSettings.applicationRules,a2=[],a1,a0;for(aX=0;aX<aV.length;aX++){if(av==="add"||aM.description!==aV[aX].description){for(aU=0;aU<aV[aX].portRanges.length;aU++){a1=aV[aX].portRanges[aU];a2.push({first:a1.firstPort,last:a1.lastPort||a1.firstPort,protocol:a1.protocol,description:aV[aX].description})}}}for(aX=0,aZ=aT.length;aX<aZ;aX++){if(aD.doPortRangesOverlap(a2,aT[aX].firstPort,aT[aX].lastPort,aT[aX].protocol)){a0=aD.doPortRangesOverlap.conflict.range;aw.rangesOverlapp.elContainer=$("#portRanges-list tr:nth-of-type("+aT[aX].rowIndex+")");aw.rangesOverlapp.message({"class":"icon warning",message:b.portRangesOverlapOtherApp.format(RAINIER.util.htmlEncode(a0.description),a0.first,a0.last||a0.first,b[a0.protocol])});aS=false;break}}}if(aS){for(aX=0,aZ=aT.length;aX<aZ;aX++){delete aT[aX].rowIndex}}return aS?aW:false}function aH(){var aS=aJ();if(aS){aS.id=aS.description;aS.value=escape(aS.description);X(az,aS,escape(aM.description),av==="edit");ad(aS,aM.value);aE.close();az="";aK="";av="";aM={}}}function aB(){if(av!=="edit"){az.val("none")}az="";aK="";av="";aM={}}function aL(){aE=RAINIER.ui.dialog(aA,{onSubmit:aH,onCancel:aB,cancelClose:true});aA.find("div.close-button").unbind("click");aA.find("div.close-button").click(function(){aB();aE.close()});aN()}return{init:aL,show:aQ}}());var am=(function(){var aF=$("#bandwidth-dialog"),aH=RAINIER.ui.buildInputValidBalloon,av=aF.find('input:[name="QoSSettings.downstreamBandwidth"]'),aE=aF.find('input:[name="QoSSettings.upstreamBandwidth"]'),az={},aw="",aC={whiteSpace:false,isRequired:true,maxLen:7},ax;function ay(){function aM(aO){if($.isNumeric(aO)){var aN=parseInt(aO,10);return(aN===0||(aN>=1&&aN<=2000))}else{return false}}az.downstreamBandwidth=aH($.extend(true,{},aC,{els:av,errors:[{test:aM,when:false,message:function(){return RAINIER.util.outOfRangeMessage(1,2000)}}]}));az.upstreamBandwidth=aH($.extend(true,{},aC,{els:aE,errors:[{test:aM,when:false,message:function(){return RAINIER.util.outOfRangeMessage(1,2000)}}]}))}function aL(){var aM=true,aN=true;aM=az.downstreamBandwidth.isValid(true);aN=az.upstreamBandwidth.isValid(true);if(aM&&aN){RAINIER.ui.validation.removeInvalidMarks(aF)}return aM&&aN}function aA(aN){var aM=$("#bandwidth-dialog");var aO=$.extend(true,{},aN?w:ag)||{};aO.QoSSettings.downstreamBandwidth=(aO.QoSSettings.downstreamBandwidthbps/d.Mb).toFixed(2);aO.QoSSettings.upstreamBandwidth=(aO.QoSSettings.upstreamBandwidthbps/d.Mb).toFixed(2);delete aO.QoSSettings.downstreamBandwidthbps;delete aO.QoSSettings.upstreamBandwidthbps;RAINIER.binder.toDom(aO,aM,au)}function aB(){var aM=$("#bandwidth-dialog");$.extend(true,ag,RAINIER.binder.fromDom(aM,au));ag.QoSSettings.downstreamBandwidthbps=ag.QoSSettings.downstreamBandwidth*d.Mb;ag.QoSSettings.upstreamBandwidthbps=ag.QoSSettings.upstreamBandwidth*d.Mb;delete ag.QoSSettings.downstreamBandwidth;delete ag.QoSSettings.upstreamBandwidth}function aG(){aA();ax.show()}function aD(){if(aL()){aB();ar=aw==="Manual"?"userDefined":"auto";C();ax.close()}}function aK(){aA();RAINIER.ui.validation.removeInvalidMarks(aF);RAINIER.ui.inputBalloon.hide()}function aJ(){var aN=$("#bandwidth-dialog"),aM=aN.find("#speed-test-content"),aO=aN.find("#manual-speed-content");RAINIER.deviceManager.getAuthorityDevice(function(aP){_deviceAuthority=aP;if(aP.getCustomProperty("bandwidthSpeedSetBy")==="userDefined"){aw="Manual";aM.hide()}else{aw="SpeedTest";aO.hide()}})}function aI(){var aO=$("#bandwidth-dialog"),aM=aO.find("#speed-test-content"),aQ=aO.find("#manual-speed-content"),aP=aO.find("#run-speed-test"),aN=aO.find("#run-speed-test, #manual-speed a, .cancel, .submit");aJ();ay();ax=RAINIER.ui.dialog(aO,{cancelClose:true,onClose:aK,onSubmit:aD});aO.find("div.close-button").unbind("click").click(function(){aK();ax.close()});aO.find("#speed-test").unbind("click").click(function(){aK();aM.show();aQ.hide();aw="Auto"});aO.find("#manual-speed a").unbind("click").click(function(){if(!$(this).hasClass("disabled")){aK();aM.hide();aQ.show();aw="Manual"}});aP.unbind("click").click(function(){aN.prop("disabled",true).addClass("disabled");aO.addClass("running");ab({skipLastCheck:true,cb:function(){aO.removeClass("running");aN.prop("disabled",false).removeClass("disabled");am.toDom()}})})}return{init:aI,toDom:aA,fromDom:aB,isValid:aL,show:aG}}());var an=(function(){var aD=$("#settings-dialog"),av=aD.find('input:[name="QoSSettings.downstreamBandwidth"]'),aF=RAINIER.ui.buildInputValidBalloon,aw={},aA={validCharSet:"numeric",whiteSpace:false,isRequired:true,maxLen:7},aG;function ax(){function aK(aM){if($.isNumeric(aM)){var aL=parseInt(aM,10);return(aL===0||(aL>=500&&aL<=2000000))}else{return false}}aw.downstreamBandwidth=aF($.extend(true,{},aA,{els:av,errors:[{test:aK,when:false,message:function(){return RAINIER.util.outOfRangeMessage(500,2000000)}}]}))}function aJ(){var aK=true;aK=aw.downstreamBandwidth.isValid(true);if(aK){RAINIER.ui.validation.removeInvalidMarks(aD)}return aK}function ay(aL){var aK=$("#settings-dialog");var aM=$.extend(true,{},aL?w:ag)||{};aM.QoSSettings.downstreamBandwidth=parseInt(aM.QoSSettings.downstreamBandwidthbps/d.Kb,10);aM.WLANQoSSettings.isWirelessAcknowledgementDisabled=!aM.WLANQoSSettings.isWirelessAcknowledgementEnabled;delete aM.QoSSettings.downstreamBandwidthbps;delete aM.WLANQoSSettings.isWirelessAcknowledgementEnabled;RAINIER.binder.toDom(aM,aK,au)}function az(){var aK=$("#settings-dialog");$.extend(true,ag,RAINIER.binder.fromDom(aK,au));ag.QoSSettings.downstreamBandwidthbps=ag.QoSSettings.downstreamBandwidth*d.Kb;ag.WLANQoSSettings.isWirelessAcknowledgementEnabled=!ag.WLANQoSSettings.isWirelessAcknowledgementDisabled;delete ag.QoSSettings.downstreamBandwidth;delete ag.WLANQoSSettings.isWirelessAcknowledgementDisabled}function aE(){ay();aG.show()}function aC(){if(aJ()){az();aG.close()}}function aI(){ay()}function aB(){if(!RAINIER.network.isQoSSupported()){$("#media-pri-settings-separator").hide();aq.hide()}}function aH(){var aK=$("#settings-dialog");ax();aG=RAINIER.ui.dialog(aK,{cancelClose:true,onClose:aI,onSubmit:aC});aK.find("div.close-button").unbind("click");aK.find("div.close-button").click(function(){aI();aG.close()})}return{init:aH,initDom:aB,toDom:ay,fromDom:az,isValid:aJ,show:aE}}());var Y=(function(){var aw={};function aD(){I.empty();s.empty();ai.empty();j.empty()}function aE(aU,aT){$.each(aT,function(){aU.append($(F.formatObj(this)))})}function aN(){U.empty();U.append($(D.find(".option-templates .select-app").clone(true)));aE(U,d.applicationStaticList);U.append($(D.find(".option-templates .add-new-app").clone(true)));Y.enableAppLinks(false)}function aK(){T.empty();T.append($(D.find(".option-templates .select-game").clone(true)));aE(T,d.gameStaticList);T.append($(D.find(".option-templates .add-new-game").clone(true)));Y.enableGameLinks(false)}function aO(aU){var aT=A.find("select");aU.value=escape(aU.description);X(aT,aU,undefined,true)}function az(){var aT;aD();ah(w.QoSSettings.applicationRules);aN();aK();var aW=d.sortRules(w.QoSSettings.deviceRules,w.QoSSettings.applicationRules),aV={};function aU(aY,aX){if(aY==="dev"){aV[aX.macAddress]=true}}if(N.mobileGaming&&!aW.high.length){D.find(".applet-button-section .submit").prop("disabled",true)}$.each(aW.high,function(aX){var aY=this.rule;aU(this.ruleType,aY);aT=d.getMediaData(this.ruleType,aY,false);d.buildLi(ao,I,aT);if(aT.isUserDefined){aO(aT)}if(this.ruleType==="app"){$.each(w.QoSSettings.applicationRules,function(){if(this.description===aY.description){this.order=aX;return false}})}else{$.each(w.QoSSettings.deviceRules,function(){if(this.macAddress===aY.macAddress){this.order=aX;return false}})}});$.each(w.devices,function(aX,a1){var a0=a1.knownMACAddresses(),aY;for(var aZ=0;aZ<a0.length;aZ++){if(aV[a0[aZ]]){aY=true}}if(!aY){d.buildLi(ao,s,{macAddress:a0[0],icon:RAINIER.ui.getDeviceIcon(a1),description:a1.friendlyName(),value:escape(a1.friendlyName()),mediaType:y.type.device})}})}function av(aT,aV){for(var aU=0;aU<aT.length;aU++){aT[aU].priority=aV}return aT}function aG(){RAINIER.ui.showWaiting();at.resetQoS(aH)}function aH(){var aT=RAINIER.jnap.Transaction({onComplete:function(){Z();RAINIER.event.fire("connection.applets.mediaPrioritization.change");RAINIER.event.fire("connection.applets.mediaPrioritization.reset");RAINIER.ui.hideWaiting()}});at.getQoS(aT,function(aU){w.QoSSettings=$.extend(true,{},aU);ag.QoSSettings=$.extend(true,{},aU)});at.getWLANQoSSettings(aT,function(aU){w.WLANQoSSettings=$.extend(true,{},aU);ag.WLANQoSSettings=$.extend(true,{},aU)});aT.send()}function ax(){a=RAINIER.ui.dialog($("#confirm-reset-dialog"),{onSubmit:function(){if(!S.is(":checked")){S.prop("checked",true);S.change()}aG()}});P=RAINIER.ui.dialog($("#confirm-delete-dialog"),{onSubmit:function(){var aV=P.elSelect.find("option:selected").prop("value"),aU=I.add(ai).add(j).find('li:[name="'+aV+'"]');if(aU&&aU.length&&aU.hide){aU.hide(500,function(){aU.detach();aU.remove()})}l(P.elSelect,aV)}});var aT=P.show;P.show=function(aU){var aW=aU.find("option:selected").data(),aV=$("#confirm-delete-dialog");P.elSelect=aU;aV.find(".del-app").toggle(aW.mediaType===y.type.application);aV.find(".del-game").toggle(aW.mediaType===y.type.onlineGame);aV.find("#message").html(b.confirmDeleteApp.format(aW.description));aT()}}function aS(aT){H.toggleClass("disabled",!aT);H.unbind("click");R.toggleClass("disabled",!aT);R.unbind("click");t.find("span").toggleClass("disabled",!aT);if(aT){H.click(function(){B.show("edit","app",U)});R.click(function(){P.show(U,y.type.application)})}}function aI(aT){af.unbind("click");af.toggleClass("disabled",!aT);Q.unbind("click");Q.toggleClass("disabled",!aT);r.find("span").toggleClass("disabled",!aT);if(aT){af.click(function(){B.show("edit","game",T)});Q.click(function(){P.show(T,y.type.onlineGame)})}}function aF(){x.click(a.show);aq.click(an.show);D.find("#showWidget").bind("click",function(){RAINIER.connect.AppletManager.toggleWidgetShowState(d.appletId,d.widgetId)})}function aP(){aw.appConflict=RAINIER.ui.inputBalloon.add({isComposite:true,els:U,elContainer:U,errors:[{test:function(){return false},when:true,message:""}],isRequired:false})}function aQ(){var aT=[],aV=[];function aU(aX,a4,aZ,a0,aY){var a2=$(a4),a3=a2.data(),a1=a3.macAddress;aV.push({description:a2.data("description"),macAddress:a1,trafficType:aZ,priority:a0,userPrioritized:aY,order:aX})}function aW(aX,a2,aY,aZ){var a0=$(a2),a1=a0.data();if(!a1){console.warn(["addAppRule","data does not exist","data:",a1])}else{if(!a1.portRanges){console.warn(["addAppRule","data.portRanges does not exist","data:",a1])}}aT.push({description:a0.data("description"),portRanges:av(a1.portRanges,aZ),trafficType:aY,order:aX})}I.find("li").each(function(aX,a0){var aZ=$(this).data("mediaType"),aY=y.trafficType.video;switch(aZ){case y.type.device:aU(aX,a0,aY,y.priority.high,!!$(this).data("userPrioritized"));break;case y.type.onlineGame:case y.type.application:aW(aX,a0,aY,y.priority.high);break;default:console.warn("app didn't get saved in the high pri list because the mediaType was unknown")}});ag.QoSSettings.applicationRules=$.extend(true,[],aT);ag.QoSSettings.deviceRules=$.extend(true,[],aV)}function aB(){$.extend(true,ag,RAINIER.binder.fromDom($("#media-pri-applet section"),au));if(RAINIER.network.isQoSSupported()){an.fromDom()}if(!N.videoCalls){delete ag.LVVPSettings}if(RAINIER.network.isHealthCheckRequiredByQoS()){am.fromDom()}else{delete ag.QoSSettings.downstreamBandwidth;delete ag.QoSSettings.upstreamBandwidth}delete ag.QoSSettings.bandwidthUnit;delete ag.QoSSettings.isBandwidthAuto;aQ()}function aR(){$.delAttr(w.QoSSettings,"maxDescriptionLength","maxApplicationRules","maxPortRanges","maxDeviceRules");$.delAttr(ag,"devices");$.delAttr(ag.QoSSettings,"maxDescriptionLength","maxApplicationRules","maxPortRanges","maxDeviceRules");$.each(w.QoSSettings.deviceRules,function(){rule=this;$.each(ag.QoSSettings.deviceRules,function(){if(rule.macAddress===this.macAddress){if(RAINIER.network.isGamingPrioritizationSupported()){_.extend(rule,this);return false}if(RAINIER.util.isNoE(rule.order)){rule.order=this.order}this.description=rule.description;if(!RAINIER.util.isNoE(this.userPrioritized)){rule.userPrioritized=this.userPrioritized}return false}})})}function ay(){var aT=false;aB();aR();if(RAINIER.network.isGamingPrioritizationSupported()){aT=!$.compare(d.filterJnapData(w.QoSSettings),d.filterJnapData(ag.QoSSettings))}else{aT=!$.compare(w.QoSSettings,ag.QoSSettings)||!$.compare(w.WLANQoSSettings,ag.WLANQoSSettings)}return aT}function aL(){if(ay()){if(N.videoCalls&&ag.QoSSettings.isQoSEnabled&&w.LVVPSettings.isEnabled){RAINIER.ui.dialog($("#confirm-disable-video-calls"),{onSubmit:aJ}).show()}else{aJ()}}else{o.onClose()}}function aJ(){var aT={apps:[],devices:[]};RAINIER.ui.showWaiting();$.each(ag.QoSSettings.deviceRules,function(aU){aT.devices[aU]={macAddress:this.macAddress,order:this.order};delete this.order;if(this.userPrioritized){RAINIER.deviceManager.getDeviceByMACAddress({macAddress:this.macAddress,cb:function(aV){aV.setCustomProperty(aa,"userPrioritized")}})}delete this.userPrioritized});$.each(ag.QoSSettings.applicationRules,function(aU){aT.apps[aU]={name:this.description,order:this.order};delete this.order});console.warn(["sortOrder:",aT]);RAINIER.deviceManager.getAuthorityDevice(function(aU){aU.setCustomProperty(V,JSON.stringify(aT),function(){var aV=RAINIER.jnap.Transaction({onComplete:function(aY){if(aY&&aY.responses){var aZ=true;for(var aX=0;aX<aY.responses.length;aX++){if(aY.responses[aX].result!=="OK"){aZ=false}}RAINIER.ui.hideWaiting();if(aZ){RAINIER.event.fire("connection.applets.mediaPrioritization.change",ag);o.onClose()}}}});var aW=d.filterJnapData(ag.QoSSettings);aU.setCustomProperty("bandwidthSpeedSetBy",ar);at.setQoS(aV,aW,function(){w.QoSSettings=$.extend(true,{},ag.QoSSettings)});at.setWLANQoSSettings(aV,ag.WLANQoSSettings,function(){$.extend(true,w.WLANQoSSettings,ag.WLANQoSSettings)});aV.send()})})}function aA(aX,a0,a5,a6,a2){var aV=RAINIER.ui.validation.tests,a7=[],aW,a4,aU,a1,a3,aT=true;a0.empty();if(this.value==="AddNew"){B.show("add",(a5===y.type.onlineGame?"game":"app"),aX)}else{if(this.value!=="none"){aW=a6[unescape(this.value)];if(!aW){if($(this).find(":selected").length){aW=$(this).find(":selected").data();a3=true}}if(aW){aU=aW.portRanges||[];I.find("li").each(function(){var a8=$(this).data();if(a8.description!==aW.description){if(a8.mediaType===y.type.application||a8.mediaType===y.type.onlineGame){for(var a9=0;a9<a8.portRanges.length;a9++){a4=a8.portRanges[a9];a7.push({first:a4.firstPort,last:a4.lastPort||a4.firstPort,protocol:a4.protocol,description:a8.description})}}}});for(var aY=0,aZ=aU.length;aY<aZ;aY++){if(aV.doPortRangesOverlap(a7,aU[aY].firstPort,aU[aY].lastPort,aU[aY].protocol)){a1=aV.doPortRangesOverlap.conflict.range;aw.appConflict.elContainer=aX;aw.appConflict.message({"class":"icon warning",message:b.portRangesOverlapOtherApp.format(RAINIER.util.htmlEncode(a1.description),a1.first,a1.last||a1.first,b[a1.protocol])});aT=false;break}}if(aT&&!aj(aW.description)){aW.mediaType=a5;aW.icon=a2;aW.value=this.value;d.buildLi(ao,a0,aW)}}if(aT){RAINIER.ui.inputBalloon.hide()}}else{if(this.value==="none"){a0.empty()}}}if(a5===y.type.onlineGame){aI(aW&&a3)}else{aS(aW&&a3)}}function aC(){U.change(aA.curry(U,ai,y.type.application,d.applicationStaticList,p));T.change(aA.curry(T,j,y.type.onlineGame,d.gameStaticList,ak));az()}function aM(){ax();aF();aP()}return{init:aM,populate:aC,populateLists:az,hasChanges:ay,refreshStoreFromDom:aB,enableAppLinks:aS,enableGameLinks:aI,scrubData:aR,save:aL}}());function Z(av){S.prop("checked",w.QoSSettings.isQoSEnabled);S.change();D.find("#showWidget").prop("checked",RAINIER.connect.AppletManager.getWidgetShowState(d.appletId,d.widgetId));Y.populate();an.initDom();an.toDom(av);if(RAINIER.network.isHealthCheckRequiredByQoS()){am.toDom(av);C(av)}I.sortable("refresh")}function C(av){var ax;var aw=av?w.QoSSettings:ag.QoSSettings;D.find("#speed-result .speed-test-complete").html(RAINIER.ui.strings.mediaPrioritization.speedTestResult.formatObj({downloadSpeed:(aw.downstreamBandwidthbps/d.Mb).toFixed(2),uploadSpeed:(aw.upstreamBandwidthbps/d.Mb).toFixed(2)}));ax=$("#speed-result a");ax.unbind("click");ax.click(am.show)}function z(){var av=RAINIER.binder.fromDom(D.find("#videoCalls"),au);$.extend(true,ag.LVVPSettings,av.LVVPSettings)}function v(){RAINIER.binder.toDom(w,D.find("#videoCalls"),au)}function M(){z();return !$.compare(w.LVVPSettings,ag.LVVPSettings)}function ac(){if(!$.compare(w.LVVPSettings,ag.LVVPSettings)){if(ag.LVVPSettings.isEnabled&&w.QoSSettings.isQoSEnabled){RAINIER.ui.dialog($("#confirm-disable-priority-by-device"),{onSubmit:f}).show()}else{f()}}else{o.onClose()}}function f(){var ax=function(ay){RAINIER.ui.hideWaiting();if(ay&&ay.result==="OK"){RAINIER.event.fire("connection.applets.mediaPrioritization.change",ag);o.onClose()}};var av=RAINIER.jnap.Transaction({onComplete:ax});RAINIER.ui.showWaiting();av.add({action:"/jnap/lvvp/SetLVVPSettings",data:ag.LVVPSettings,cb:function(ay){if(ay.result==="OK"){$.extend(true,w.LVVPSettings,ag.LVVPSettings)}}});if(ag.LVVPSettings.isEnabled&&w.QoSSettings.isQoSEnabled){ag.QoSSettings.isQoSEnabled=false;Y.scrubData();var aw=_.clone(ag.QoSSettings);aw.deviceRules=_.map(aw.deviceRules,function(ay){return _.omit(ay,["order","userPrioritized"])});at.setQoS(av,aw,function(){$.extend(true,w.QoSSettings,aw);Z()})}av.send()}function g(av){var aw=false;switch(G){case"videoCalls":if(M()){aw=true;ac()}break;case"byDevice":if(Y.hasChanges()){aw=true;Y.save()}break}if(av&&!aw){o.onClose()}return true}function K(){var av=false;switch(m){case"videoCalls":av=M();break;case"byDevice":av=Y.hasChanges();break}if(av){G=m;al.show()}return av}function i(){switch(G){case"videoCalls":v();break;case"byDevice":Z(true);break}}function J(){var av=N.videoCalls?$.cookie("initial-tab"):"byDevice";n=RAINIER.ui.tabs.init({fireEvents:true,initialTab:av});n.connect(function(ax,aw){if(aw.type==="tab"){m=aw.srcTabId;G=aw.destTabId;if(aw.srcIdx>-1){E=aw.destTab;if(K()){ax.cancelEvent=true}}else{m=G}}});n.fireInit();if(!N.videoCalls){return D.find("ul.tabs").hide()}al=RAINIER.ui.dialog($("#dialog-tabchange"),{onSubmit:function(){e=true;g(false)}});$("#dialog-tabchange #no-save").unbind("click");$("#dialog-tabchange #no-save").click(function(){al.close();i();E.click()})}function W(av){d=av;N.videoCalls=RAINIER.network.isLvvpSupported();N.mobileGaming=RAINIER.network.isGamingPrioritizationSupported();if(!RAINIER.shared.util.areServicesSupported(d.requiredServices)&&!N.mobileGaming){RAINIER.event.fire("applet.unsupportedFirmware");return}if(!N.videoCalls&&!N.mobileGaming){D.find("#warningWrapper").removeClass("hidden")}$.extend(true,at,d.jnap);J();d.load(function(ax){w=$.extend(true,{},ax);$.extend(true,ag,w);B.init();v();Z();RAINIER.event.fire("applet.loaded")});setTimeout(function aw(){RAINIER.network.checkInternetConnection(function(ax){if(ax){if(RAINIER.network.isHealthCheckRequiredByQoS()){D.find(".embedded-speedtest-supported").show();D.find("#settings-download-bandwidth").hide();ab({autoSave:true,cb:am.toDom})}else{if(!RAINIER.network.isAuthorityRemote()){OOKLA.check_bandwidth_calibration(function(ay){if(ag&&ag.QoSSettings){ag.QoSSettings.downstreamBandwidthbps=ay.output.downstreamBandwidthbps}})}}}});Y.init();ae.init();an.init();am.init();RAINIER.ui.placeholders.init();D.find("footer .cancel").click(o.onClose);D.find("footer .submit").click(function(){g(true)})},0)}function ab(aw){aw=aw||{};var aB,av=D.find("#speed-result"),aA=(typeof aw.cb==="function")?aw.cb:$.noop;function ax(aC){var aE=new Date(),aD=aC.output.healthCheckResults[0].speedTestResult;if(!w.QoSSettings.downstreamBandwidthbps||!w.QoSSettings.upstreamBandwidthbps){aw.autoSave=true}w.QoSSettings.downstreamBandwidthbps=aD.downloadBandwidth*d.Kb;w.QoSSettings.upstreamBandwidthbps=aD.uploadBandwidth*d.Kb;w.QoSSettings.downstreamBandwidthbps=(w.QoSSettings.downstreamBandwidthbps/d.Mb).toFixed(2)*d.Mb;w.QoSSettings.upstreamBandwidthbps=(w.QoSSettings.upstreamBandwidthbps/d.Mb).toFixed(2)*d.Mb;if(!$.compare(w.QoSSettings.downstreamBandwidthbps,ag.QoSSettings.downstreamBandwidthbps)||!$.compare(w.QoSSettings.upstreamBandwidthbps,ag.QoSSettings.upstreamBandwidthbps)){aw.autoSave=true}ag.QoSSettings.downstreamBandwidthbps=w.QoSSettings.downstreamBandwidthbps;ag.QoSSettings.upstreamBandwidthbps=w.QoSSettings.upstreamBandwidthbps;Y.scrubData();w.QoSSettings.deviceRules=_.map(w.QoSSettings.deviceRules,function(aF){return _.omit(aF,["order","userPrioritized"])});av.removeClass("running");if(aw.autoSave){RAINIER.jnap.send({action:RAINIER.jnapActions.setQoSSettings(),data:w.QoSSettings,cb:function(aF){aB.setCustomProperty("lastBandwidthCalibrationDate",aE.getTime().toString());aB.setCustomProperty("bandwidthSpeedSetBy","auto");C();aA()},disableDefaultAjaxErrHandler:true,disableDefaultJnapErrHandler:true,disableDefaultRebootErrHandler:true})}else{aA()}}function az(aC){if(aC.allStepsDone&&ag&&ag.QoSSettings){setTimeout(function(){symmetryUtil.monitors.healthCheck.getResults("SpeedTest",1).success(ax)},5000)}}function ay(aC){if(aC==="ErrorHealthCheckAlreadyRunning"){symmetryUtil.monitors.healthCheck.stop().success(function(){setTimeout(function(){symmetryUtil.monitors.healthCheck.start("SpeedTest",az,$.noop,{timeout:35000,retry:1})},3000)})}}RAINIER.deviceManager.getAuthorityDevice(function(aC){aB=aC;if(!aC.getCustomProperty("lastBandwidthCalibrationDate")||aC.getCustomProperty("lastBandwidthCalibrationDate").length===0||aw.skipLastCheck){D.find("#speed-result").addClass("running");symmetryUtil.monitors.healthCheck.start("SpeedTest",az,ay,{timeout:35000,retry:1})}})}W(RAINIER.applets.MediaPrioritization)}());