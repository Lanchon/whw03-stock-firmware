window.RAINIER=window.RAINIER||{};RAINIER.applets=RAINIER.applets||{};RAINIER.applets.MediaPrioritization=RAINIER.applets.MediaPrioritization||(function(){var o="9BDB14C9-C328-40ED-89A9-A3A822B8B5D2",u="BBB6425B-D3A1-45D6-8A68-B80DC37502A6",q=["/jnap/qos/QoS"],c="urn:cisco-com:ui:qos-order",r={apps:[],devices:[]},l=1000;Mb=l*1000;var g={type:{device:"device",application:"application",onlineGame:"onlineGame"},priority:{low:"Low",normal:"Normal",medium:"Medium",high:"High"},trafficType:{background:"Background",generic:"Generic",voice:"Voice",video:"Video"},protocol:{TCP:"TCP",UDP:"UDP",Both:"Both"}};var k="device-icon online-game",s="device-icon application";var p={devices:[],QoSSettings:{applicationRules:[],deviceRules:[]},QoSSettingsSetup:{},WLANQoSSettings:{}},f={QoSSettings:{applicationRules:[],deviceRules:[]},WLANQoSSettings:{}};var e={getQoS:function a(w,v){w.add({action:RAINIER.jnapActions.getQoSSettings(),data:{},cb:function(y){if(y.result==="OK"){if(RAINIER.network.isGamingPrioritizationSupported()){var x=y.output;$.extend(true,x,{isQoSEnabled:x.isEnabled,deviceRules:_.map(x.macAddresses,function(z){return{macAddress:z}}),maxDeviceRules:x.maxPrioritizedDevices,applicationRules:[]});$.delAttr(x,"isEnabled","macAddresses","maxPrioritizedDevices")}RAINIER.deviceManager.getAuthorityDevice(function(z){var A=z.getCustomProperty(c);if(A){r=JSON.parse(A);console.warn("sortOrder loaded: %o",A)}});v(y.output)}else{console.warn("GetQoSSettings: o.output is empty. Terminating...error:"+y.error+" result: "+y.result)}}})},getWLANQoSSettings:function(w,v){if(RAINIER.network.isQoSSupported()){w.add({action:"/jnap/qos/GetWLANQoSSettings",data:{},cb:function(x){if(x.result==="OK"){v(x.output)}else{console.warn("GetWLANQoSSettings: o.output is empty. Terminating...error:"+x.error+" result: "+x.result)}}})}},getLVVPSettings:function(w,v){if(RAINIER.network.isLvvpSupported()){w.add({action:"/jnap/lvvp/GetLVVPSettings",data:{},cb:function(x){if(x.result==="OK"){v(x.output)}else{console.warn("GetLVVPSettings: o.output is empty. Terminating...error:"+x.error+" result: "+x.result)}}})}}};function h(y,z){var w=[],x={high:[]},v=0;y.forEach(function(B,A){$.each(r.devices,function(C,D){if(B.macAddress===D.macAddress){v=D.order;return}});w.push({ruleList:"dev",rule:y[A],score:v})});z.forEach(function(B,A){$.each(r.apps,function(D,C){if(B.description===C.name){v=C.order;return}});w.push({ruleList:"app",rule:z[A],score:v})});w.sort(function(B,A){return(B.score-A.score)});w.forEach(function(A){var B;B=A.ruleList;if(x.high.length<3){x.high.push({ruleType:B,rule:A.rule})}});return x}function i(x,w,y){if(typeof y.description==="undefined"||typeof y.value==="undefined"||typeof y.icon==="undefined"||typeof y.mediaType==="undefined"){console.warn("buildLi data is missing required attribute")}else{var v=$(x.formatObj(y));v.data(y);w.append(v)}}function b(z,C){var v=RAINIER.applets.MediaPrioritization,y=false,A,w,E,D,B;if(z==="dev"){$.each(p.devices,function(F,I){var H=I.knownMACAddresses();for(var G=0;G<H.length;G++){if(H[G]===C.macAddress){A=I;break}}});if(A){B=RAINIER.ui.getDeviceIcon(A);D=A.friendlyName();E=g.type.device}}else{if(z==="app"){w=v.gameStaticList[C.description];if(w){E=g.type.onlineGame;B=k}else{E=g.type.application;w=v.applicationStaticList[C.description];B=s;if(!w){w=C;y=true}}D=w.description}}var x={mediaType:E,description:D,value:escape(D),icon:B,isUserDefined:y};if(z==="dev"){x.macAddress=C.macAddress}else{if(z==="app"){x.portRanges=w.portRanges}}return x}function n(){var v=new $.Deferred();function w(x){$.each(x,function(){this.value=escape(this.description)})}$.getJSON("/ui/dynamic/applets/media_prioritization/applications.json",function(x){$.extend(RAINIER.applets.MediaPrioritization,{applicationStaticList:x.applicationStaticList,gameStaticList:x.gameStaticList});w(x.applicationStaticList);w(x.gameStaticList);v.resolve("get app data complete")});return v}function t(v){if(RAINIER.network.isGamingPrioritizationSupported()){v={isEnabled:v.isQoSEnabled,macAddresses:_.pluck(v.deviceRules,"macAddress")}}return v}function m(){var v=new $.Deferred();var w=RAINIER.jnap.Transaction({onComplete:function(){v.resolve("jnap trans complete")}});e.getQoS(w,function(x){x.downstreamBandwidthbps=Math.round(x.downstreamBandwidthbps/l)*l;p.QoSSettings=$.extend(true,{},x);f.QoSSettings=$.extend(true,{},x)});e.getWLANQoSSettings(w,function(x){p.WLANQoSSettings=$.extend(true,{},x);f.WLANQoSSettings=$.extend(true,{},x)});e.getLVVPSettings(w,function(x){p.LVVPSettings=$.extend(true,{},x);f.LVVPSettings=$.extend(true,{},x)});w.send();return v}function d(){var v=$.Deferred();RAINIER.deviceManager.getDevices(function(w){$.each(w,function(){this.mediaType=g.type.device});p.devices=w;v.resolve("load devices complete")},{excludeAuthority:true,excludeNodes:true},-1);return v}function j(v){var x=n(),y=d(),w=m();$.when(x,y,w).then(function(){v(p)})}return{requiredServices:q,appletId:o,widgetId:u,load:j,buildLi:i,filterJnapData:t,getMediaData:b,sortRules:h,jnap:e,Kb:l,Mb:Mb}}());