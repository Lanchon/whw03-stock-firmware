(function(a,b){if(typeof define==="function"&&define.amd){define(["lodash","./symmetry-jnap","./side-effects-manager","./device-manager"],b)}else{if(typeof module==="object"&&module.exports){module.exports=b(require("lodash"),require("./symmetry-jnap"),require("./side-effects-manager"),require("./device-manager"))}else{a.utilFirmwareUpdate=b((a.lodash||a._),a.JNAP,a.sideEffectsManager,a.deviceManager)}}}(this,function(ao,r,U,X){var ab;var j=12*60*1000;var H=8*60*1000;var d,M,ae=[],g,c,Q,ad,n,am,O,Z,k,K,af,R,V,t,m,ak,o=false,T=null,B=null,S,z,v,G,ac={},P="[not found]",a="[no update available]",L="[ firmware-update ]";var C=/(\d+)\..+/;var aj={disablePause:true};function s(ar){var ap;if(o){var aq=ao.result(af,"output.firmwareUpdateStatus",{});ap=ao.result(ao.find(aq,"lastOperationFailure"),"lastOperationFailure","[UpdateFailed]")}else{ap=ao.result(af,"output.lastOperationFailure","[UpdateFailed]")}G("error","lastOperationFailure reported:",ap);ad(af);ar(true)}function i(ap){r.send("/firmwareupdate/GetFirmwareUpdateStatus").success(function(aq){var at=ao.result(aq,"output",{}),au=at.lastSuccessfulCheckTime&&(at.lastSuccessfulCheckTime!==d),ar=ao.result(at,"pendingOperation.operation")==="Checking";af=aq;R=ao.result(at,"lastOperationFailure");if(R){s(ap);return}else{if(ao.has(at,"availableUpdate")||(au&&!ar)){ap(true)}else{ap(false)}}}).error(function(){ap(false)})}function N(ap){r.send("/nodes/firmwareupdate/GetFirmwareUpdateStatus").success(function(aq){var at=ao.result(aq,"output.firmwareUpdateStatus",[]),av=(k<=at.length),ar=ao.find(at,"pendingOperation")||!av;var au=!ao.isEmpty(at)&&ao.find(at,"lastSuccessfulCheckTime")&&d<Y(aq,Math.min);af=aq;R=ao.find(at,"lastOperationFailure");if(R){s(ap);return}ap(au&&!ar)}).error(function(){ap(false)})}function f(ap){r.send("/firmwareupdate/GetFirmwareUpdateStatus",{},aj).success(function(aq){var at=ao.result(aq,"output",{}),au,ar;af=aq;R=ao.result(at,"lastOperationFailure");if(R){s(ap);return}else{if(at.pendingOperation){au=at.pendingOperation.operation;ar=at.pendingOperation.progressPercent}}if(!au&&aq.result==="OK"){c(ap);return}else{if(au==="Checking"){n(ar/6,au)}else{if(au==="Downloading"){n(16.5+ar/6,au)}else{if(au==="Installing"){n(33+ar/3,au)}else{if(au==="Rebooting"){am()}}}}}ap(false)}).error(function(){am();ap(false)})}function x(aq,ap){return ao.find(aq,function(ar){return ao.result(ar,"pendingOperation.operation")===ap})}function W(ap){return ao.find(ao.result(ap,"output.firmwareUpdateStatus"),function(aq){return ao.result(aq,"pendingOperation.progressPercent")===100})}function Y(ap,ar){var aq=ar();ao.each(ao.result(ap,"output.firmwareUpdateStatus"),function(at){if(at.lastSuccessfulCheckTime){aq=ar(aq,ab.time.routerTimeToDate(at.lastSuccessfulCheckTime))}});return aq}function p(ap){return ap.isOnline}function D(aq,av){var at=2,au=22,ap=26,ar=50;if(V==="Rebooting"||aq==="Rebooting"){if(V!=="Rebooting"){U.fakeProgress.start(function(aw){n(at+au+ap+(aw*ar/100),"Rebooting")},j*ar/100)}V="Rebooting"}else{if(V==="Installing"||aq==="Installing"){if(!U.fakeProgress.isRunning()){U.fakeProgress.start(function(aw){n(at+au+(aw*ap/100),"Installing")},j*ap/100)}V="Installing"}else{if(aq==="Downloading"){n(at+(av*au/100),"Downloading");V=aq}else{if(aq==="Checking"){n(av*at/100,"Downloading");V=aq}}}}}function b(){if(T){T=null;G("info","finallyFunction - FW op no longer in progress");if(U.fakeProgress.isRunning()){U.fakeProgress.stop()}if(Z){X.setOptions({doPolling:true})}}}function E(aq){o=r.isFeatureSupported("Node");var ap=o?"/nodes/firmwareupdate/GetFirmwareUpdateStatus":"/firmwareupdate/GetFirmwareUpdateStatus",at=o?45:15;if(ac.enableTraceLogging){G("info","Debug info - firmwareCheck() start - Traces",{"do-trace":true,"log-keys":true,jnapAction:ap})}if(T){var ar="firmwareCheck - FW op already in progress, exiting (opInProgress)";G("error",ar,T);throw ar+": "+T}if(!ao.isFunction(aq.success)){throw"Missing success callback"}if(!ao.isFunction(aq.error)){throw"Missing error callback"}B=T="Check";aq.timeStart=(new Date()).getTime();ab.logging.clearLogKey(L);G("info","firmwareCheck - No FW op in progress, initiating check (timeStart):",aq.timeStart);r.send(ap).success(function(au){if(o){d=Y(au,Math.max);X.getDevices(true,true).success(function(){k=ao.filter(X.nodes.getAll(),p).length;G("info","firmwareCheck - Online Nodes:",k);I(aq,N,at,true)})}else{d=au.output.lastSuccessfulCheckTime;I(aq,i,at,true)}}).error(function(){T=null;aq.error()})}function al(ap){if(!ap){ad("ConnectivityFailure")}else{aa(null)}}function aa(ar,aq){var ap=ao.isFunction(ar);aq=aq||0;c(function(at){if(!ar&&!at){G("info","Unable to talk to Router, polling for Reconnection for up to 6 mins");var aw=(new Date()).getTime()+6*60*1000,au=3*1000,av=5*1000;U.poll(c,al,null,aw,au,av)}else{if(!ap){G("info","Creating final callback");ar=function(ax){if(!ax){G("info","checkInternetAndNodesUpdates - retrying (retryCount):",aq);if(aq<36){setTimeout(function(){aa(ar,++aq)},5*1000)}else{ad("FWUpdateFailed")}}else{Q(true)}}}q(at,ar)}})}function h(aq){if(S){return aq(true)}var ap={supportedForCaching:{"/core/GetDeviceInfo":false}};r.send("/core/GetDeviceInfo",{},ap).success(function(ar){var at=ao.result(ar,"output.firmwareVersion");S=at===M;G("info","isRouterUpdatedAndMatching (isFirmwareUpdateSuccessful, authority.unit.firmwareVersion):",S,at);aq(S)}).error(function(){aq(false)})}function w(at){var aq=ao.result(at,"model.modelNumber",P),ap=ao.result(at,"unit.firmwareVersion",P),ar=ao.result(at,"model.hardwareVersion",ap.replace(C,"$1"));if(ar!==P){aq+="v"+ar}return aq}function e(){var ap=r.Deferred();X.getDevices(true,true).success(function(){var aq=ao.filter(X.nodes.getAll(),p),ar=ao.map(aq,function(au){var at=au.deviceID;return{deviceID:at,deviceIcon:au.deviceIcon,deviceName:au.deviceName,model:w(au),currentVersion:ao.result(au,"unit.firmwareVersion",P),availableVersion:ao.result(ao.find(ae,{deviceID:at}),"availableVersion",P)}});ap.resolve(ar)}).error(function(aq){ap.reject(aq)});return ap}function ai(ap){if(S){return ap(true)}e().success(function(au){var at=(k<=au.length),ar=true;var aq=ao.filter(ae,function(av){return av.availableVersion!==a});ao.each(aq,function(aw){var av=ao.find(au,{deviceID:aw.deviceID})||{currentVersion:P};if(av.currentVersion!==aw.availableVersion){ar=false;return false}});S=at&&ar;G("info","areAllNodesUpdatedAndMatching (initialNodesCount, nodesCountMatches, areAllNodesUpdated, nodeVersions):",k,at,ar,ab.formatter.jsonToTable(au,["deviceID","deviceName","currentVersion","availableVersion"]));if(!ar){G("warn","Not all Nodes received availableVersion seen during Check (lastAvailableUpdateVersions)",ae)}ap(S)}).error(function(aq){G("error","failed to retrieve Nodes from Device Manager:",aq);ap(false)})}function ah(ap){ad=function(ar){R=R||ar;if(T){var aq=ao.result(ar,"output",ar),au="errorCallback - FW "+(ak?"Check":"Update")+" failed",at={"log-keys":true};if(ar===af){ao.extend(at,{lastFwUpdateStatus:aq})}else{ao.extend(at,{error:aq,lastFwUpdateStatus:af})}if(!ap.timeEnd){ap.timeEnd=(new Date()).getTime();ao.extend(at,{timeStamp:ap.timeEnd})}G("error",au,at);b();ap.error(ar)}};Q=function(ar){ap.timeEnd=(new Date()).getTime();var au={"SEM pollingSucceeded":ar,timeStart:ap.timeStart,timeEnd:ap.timeEnd,timeFromStart:ab.time.getElapsedMsReadable(ap.timeStart)};G("info","completeCallback",au);var av=ao.result(af,"output.lastOperationFailure");var at=!ao.isEmpty(ao.result(af,"output.firmwareUpdateStatus"))&&ao.find(af.output.firmwareUpdateStatus,"lastOperationFailure");var aq=!ao.isEmpty(ao.result(af,"output.firmwareUpdateStatus"))&&ao.find(af.output.firmwareUpdateStatus,"pendingOperation");if(ar&&af.result==="OK"&&!av&&!at){G("info","completeCallback - FW "+(ak?"Check":"Update")+" successful (lastFwUpdateStatus):",ao.result(af,"output",af));if(ak){ap.success(af)}else{if(o){ai(function(aw){if(aw){ap.success(af)}else{G("warn","completeCallback - areAllNodesUpdatedAndMatching returned false, calling errorCallback with lastFwUpdateStatus");ad(af)}})}else{h(function(aw){if(aw){ap.success(af)}else{G("warn","completeCallback - isRouterUpdatedAndMatching returned false, calling errorCallback with lastFwUpdateStatus");ad(af)}})}}}else{if(W(af)){aa(null);return}else{if(!ar&&V&&!at&&!aq){aa(null);return}else{ad(ar?af:"TimeoutError")}}}b()};am=function(){if(!U.fakeRebootProgress.isRunning()){U.fakeRebootProgress.start(function(aq){n(66+2/3+aq/3,"Rebooting")})}};n=function(au,aq){var at=O+au;if(z!==aq){var ar=(new Date()).getTime(),av={currentOp:aq,reportedProgress:ao.round(at,2)+"%",timeStamp:ar,timeFromStart:ab.time.getElapsedMsReadable(ap.timeStart)};if(v){av.timeFromLastOp=ab.time.getElapsedMsReadable(v)}G("info","progressCallback - operation has changed",av);z=aq;v=(new Date()).getTime()}ap.progress(at,aq)};O=ap.progressOffset||0;V=null;af=null;R=null;g=null;t=0;K=0;m=false;ak=false;S=false;z="Checking";v=null}function q(ap,aq){if(!ap){aq(ap)}else{if(K%4!==0){K++;aq(false)}else{K++;ai(aq)}}}function l(aq){var ap;r.send("/nodes/firmwareupdate/GetFirmwareUpdateStatus",{},aj).success(function(ar){var at=ao.result(ar,"output.firmwareUpdateStatus",[]),au=ao.find(at,"pendingOperation");g=null;af=ar;R=ao.find(at,"lastOperationFailure");if(!au&&R){s(aq);return}else{if(au){t=0}else{if(!m){t++;if(t===25){m=true;G("info","isNodesFWUpdateCompleted - No pendingOps seen for 25 times in a row, setting doConfirmUpdate to true")}else{if(V==="Rebooting"){m=true;G("info","isNodesFWUpdateCompleted - Rebooting op reported, setting doConfirmUpdate to true")}}}}}if(m){aa(aq);return}else{if(x(at,"Rebooting")){D("Rebooting")}else{if(x(at,"Installing")){D("Installing")}else{if(x(at,"Downloading")){ap=x(at,"Downloading").pendingOperation.progressPercent;D("Downloading",ap)}else{if(x(at,"Checking")){ap=x(at,"Checking").pendingOperation.progressPercent;D("Checking",ap)}}}}}aq(false)}).error(function(ar){if(!g){g=(new Date()).getTime()}if(V==="Rebooting"||V==="Installing"){D("Rebooting");aq(false)}else{if((new Date()).getTime()-g<=H){G("warn","contact lost for under 8 minutes, continuing polling (operationReported):",V);D(V);aq(false)}else{G("error","contact lost for 8 minutes (operationReported):",V);af=ar;aq(true)}}})}function I(au,aq,ar,ay){var ap=o?"/nodes/firmwareupdate/UpdateFirmwareNow":"/firmwareupdate/UpdateFirmwareNow";var av=ay?0:5000,aw=ay?2000:2500,ax=au.pollingTimeout||2500,at=ao.has(au,"timeStopAt")?au.timeStopAt:null;ar=ao.has(au,"retryAttempts")?au.retryAttempts:ar;au=ao.cloneDeep(au);ah(au);ak=ay;c=ak?ao.noop:U.getTestRouterReconnectedFunc();Z=X.getOptions().doPolling;if(Z){X.setOptions({doPolling:false})}setTimeout(function(){r.send(ap,{onlyCheck:ay}).success(function(){if(!ay){au.progress(O,ak?"StartingCheck":"StartingDownload")}U.poll(aq,Q,ar,at,ax,aw)}).error(ad)},av)}function y(aq){o=r.isFeatureSupported("Node");var ap=o?"/nodes/firmwareupdate/GetFirmwareUpdateStatus":"/firmwareupdate/GetFirmwareUpdateStatus";if(ac.enableTraceLogging){G("info","Debug info - firmwareUpdate() start - Traces",{"do-trace":true,"log-keys":true,jnapAction:ap})}if(T){var ar="firmwareUpdate - FW op already in progress, exiting (opInProgress)";G("error",ar,T);throw ar+": "+T}if(!ao.isFunction(aq.success)){throw"Missing success callback"}if(!ao.isFunction(aq.error)){throw"Missing error callback"}if(!ao.isFunction(aq.progress)){throw"Missing progress callback"}B=T="Update";aq.timeStart=(new Date()).getTime();ab.logging.clearLogKey(L);G("info","firmwareUpdate - No FW op in progress, initiating update (timeStart):",aq.timeStart);r.send(ap).success(function(at){if(o){ae=[];if(ao.has(at,"output.firmwareUpdateStatus")){if(ao.find(at.output.firmwareUpdateStatus,"pendingOperation")){aq.error("UpdateOrCheckInProgress");return}}else{G("warn","No firmwareUpdateStatuses returned")}X.getDevices(true,true).success(function(){k=ao.filter(X.nodes.getAll(),p).length;ae=ao.map(at.output.firmwareUpdateStatus,function(av){var au=X.getDeviceByID(av.deviceUUID);return{deviceID:av.deviceUUID,deviceName:au.deviceName,currentVersion:ao.result(au,"unit.firmwareVersion",P),availableVersion:ao.result(av,"availableUpdate.firmwareVersion",a)}});G("info","Starting Nodes FW Update (online Nodes, lastAvailableUpdateVersions):",k,ab.formatter.jsonToTable(ae,["deviceID","deviceName","currentVersion","availableVersion"]));I(aq,l,336,false)}).error(aq.error)}else{M=ao.result(at.output,"availableUpdate.firmwareVersion");G("info","Starting FW Update (lastAvailableUpdateVersion):",M);I(aq,f,180,false)}}).error(aq.error)}function u(){return ab.logging.getLogKey(L)}function J(){return T}function an(){return B}function F(){return Boolean(R)}function A(ap){if(ao.isEmpty(ap)||!ao.isObject(ap)){throw"setOptions - Need to pass an object of options; call getOptions() to see format"}ac=ao.merge(ac,ap)}function ag(){ac={enableTraceLogging:false}}ag();return function(ap){ab=ap;G=ab.logging.setup(L,true);return{check:E,update:y,setOptions:A,resetOptions:ag,getRouterModelLabel:w,isRouterUpdatedAndMatching:h,getNodesFirmwareVersions:e,areAllNodesUpdatedAndMatching:ai,getLatestCombinedLogs:u,getOpInProgress:J,getLastOpPerformed:an,isLastOpFailed:F}}}));