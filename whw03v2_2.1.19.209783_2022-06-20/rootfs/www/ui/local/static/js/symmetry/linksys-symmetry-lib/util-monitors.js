(function(a,b){if(typeof define==="function"&&define.amd){define(["jquery","lodash","./symmetry-jnap"],b)}else{if(typeof module==="object"&&module.exports){module.exports=b(require("jquery"),require("lodash"),require("./symmetry-jnap"))}else{a.utilMonitors=b(a.$,(a.lodash||a._),a.JNAP)}}}(this,function(M,ak,n){var aa;var z="[ util-monitors ]",x;var P={};var C="-1";var J="";var ah="https://cloudhealth.lswf.net/cloud-availability/";var t=3000,s=15000,X=10000;var N=null,aj=[{result:"speedTestResult",step:"latency"},{result:"speedTestResult",step:"downloadBandwidth"},{result:"speedTestResult",step:"uploadBandwidth"}];function ab(al){return n.send("/nodes/healthcheck/GetHealthCheckStatus",{},al||N)}function Q(am,an,al){return n.send("/nodes/healthcheck/GetHealthCheckResults",{includeModuleResults:true,healthCheckModule:am,lastNumberOfResults:an},al||N)}function F(al){return al.output.speedTestResult.exitCode==="SpeedTestExecutionError"&&al.output.speedTestResult.latency&&al.output.speedTestResult.downloadBandwidth&&al.output.speedTestResult.uploadBandwidth}function q(al){if(al.result!=="OK"){return al.result||al}else{if(al.output.speedTestResult&&al.output.speedTestResult.exitCode!=="Success"&&al.output.speedTestResult.exitCode!=="Unavailable"&&!F(al)){return al.output.speedTestResult.exitCode}}return null}function l(al){return !al.output.healthCheckModuleCurrentlyRunning||q(al)}function h(al){if(al.output.healthCheckModuleCurrentlyRunning==="SpeedTest"&&al.output.speedTestResult.downloadBandwidth){return"uploadBandwidth"}else{if(al.output.healthCheckModuleCurrentlyRunning==="SpeedTest"&&al.output.speedTestResult.latency){return"downloadBandwidth"}else{if(al.output.healthCheckModuleCurrentlyRunning==="SpeedTest"){return"latency"}}}}function I(am,al){var an;M.each(al,function(ao,ap){if(ap.step===am){an=ao}});return an+1}var R,af,U=false;function G(){R=null;af=null;U=false}function v(al,an,am){setTimeout(function(){an=an||M.noop;am=am||M.noop;ab().success(function(ao){if(l(ao)){if(q(ao)){am(q(ao))}else{an({allStepsCount:al.length,stopped:U,allStepsDone:!U,speedTestResult:ak.result(af,"output.speedTestResult")})}G();return}else{v(al,an,am);af=ao;if(U){return}}var ap=h(ao);if(ap!==R){an({stepName:ap,stepNumber:I(ap,al),allStepsCount:al.length,allStepsDone:false,speedTestResult:ao.output.speedTestResult});R=ap}}).error(function(ao){am(q(ao));G()})},t)}function ai(ap,at,aq,ao,an){var ar={runHealthCheckModule:ap};var am=[];if(ap==="SpeedTest"){var al=ak.result(an,"serverID",null);if(al&&al!==C){ar.targetServerID=al}am=am.concat(aj)}n.send("/nodes/healthcheck/RunHealthCheck",ar,ao).success(function(){v(am,at,aq)}).error(function(au){aq(q(au))})}function ag(ao,an,al){N=al;var am=[];am=am.concat(aj);n.send("/nodes/healthcheck/RunHealthCheck",{},N).success(function(){v(am,ao,an)}).error(function(ap){an(q(ap))})}function S(al){U=true;return n.send("/nodes/healthcheck/StopHealthCheck",{},al||N)}var B=ak.noop,O,Y,Z,m,g,b,k,f,d=0,W=15000,c=5000,V=2,y=null;function ad(al){var ao=al.complete;function an(ap,aq,ar){return ao(am(ap,aq,ar))}function am(ap,aq,ar){return{getResponseHeader:function(at){return ak.result(ar,at)},getAllResponseHeaders:function(){var at="";ar=ar||{};ak.each(ar,function(av,au){at+=au+": "+av+" "});return at},statusText:aq,responseText:ap}}if(typeof cordova!=="undefined"){cordova.exec(an,an,"Http","request",[al])}else{M.ajax(al)}}function j(){setTimeout(function(){if(Z!==O||m!==Y){Z=O;m=Y;B()}},500)}function ae(al){d--;if(al!==Y){Y=al;j()}}function r(al){d--;if(al!==O){O=al;j();if(y){w();e()}}}function L(an,al,ao,am){if(al||!am){ao(al)}else{setTimeout(function(){an(ao,am-1)},c/(V+1))}}function K(al){var an={DEV:"cloud-dev.json",QA:"cloud-qa.json",INT:"cloud-int.json",STG:"cloud-stg.json",CLOUD:"cloud.json"},am;al=ak.words(al)[0];if(!ak.isEmpty(al)){am=an[al.toUpperCase()]}return am?ah+am:null}function p(al){f={status:ak.result(al,"status"),statusText:ak.result(al,"statusText"),contentLen:al.getResponseHeader("content-length"),contentType:al.getResponseHeader("content-type"),server:al.getResponseHeader("server")};if(!ak.isEmpty(k)&&ak.result(k,"cloudStatus")!=="OK"){f.lastCloudApiStatus=k}return f}function a(ap,al){var an=/content-type:\s+image\/png/i,ao=function(aq){return an.test(aq.getAllResponseHeaders())};var am="/cloud/ping.png";ap=ap||ae;ad({headers:{Expires:"Fri, 10 Oct 2015 14:19:41 GMT","Cache-Control":"no-cache"},url:am,type:"GET",timeout:s,cache:false,contentType:"image/png",complete:function(aq){if(ao(aq)){ap(true)}else{x("warn","testPingPng: Test failed (response info)",p(aq));L(a,false,ap,al)}}})}function E(an,al){var am=function(ao){k=ak.result(ao,"responseText");if(ak.isEmpty(k)||!ak.isPlainObject(k)){return false}return ak.result(k,"cloudStatus")==="OK"};an=an||ae;if(!J){x("warn","testCloudApi - Environment not supported for API tests, calling testPingPng (connectivityOptions.environment)",P.environment);a(an);return}ad({headers:{Expires:"Fri, 10 Oct 2015 14:19:41 GMT","Cache-Control":"no-cache"},url:J,type:"GET",timeout:X,cache:false,contentType:"application/json; charset=UTF-8",complete:function(ao){if(am(ao)){an(true)}else{x("warn","testCloudApi: Test failed (testCloudApiEnvUrl, response info)",J,p(ao));L(E,false,an,al)}}})}function T(ar,aq){var al=n.Deferred(),ap=n.Deferred(),am=true;function ao(at){g=at;if(am){al.resolve(at)}else{ar(at)}}function an(at){b=at;if(am){ap.resolve(at)}else{ar(at)}}ar=ar||ae;aa.logging.clearLogKey(z);M.when(al,ap).then(function(au,at){x("info","testCloudAvailability - Tests completed (pingPngSuccess, cloudApiSuccess, isFirstTry)",au,at,am);if(!au&&!at){aq=aq||0;x("warn","testCloudAvailability - Both tests failed (retryCount)",aq);if(aq>0){setTimeout(function(){T(ar,aq-1)},1500)}else{ar(false)}return}else{if(!au||!at){aq=ak.isNumber(aq)?aq:2;am=false;if(!au&&aq){x("info","testCloudAvailability - PingPng test failed, retrying 3 times");a(ao,2)}else{if(!at&&aq){x("warn","testCloudAvailability - CloudApi test failed, retrying 3 times");E(an,2)}else{if(aq===0){ar(false)}}}return}}ar(true)});if(J){x("info","testCloudAvailability - Starting Tests (connectivityOptions.environment, retryCount)",P.environment,aq);E(an,null)}else{x("warn","testCloudAvailability - Environment not supported for API tests, skipping testCloudApi (connectivityOptions.environment)",P.environment);ap.resolve(true)}a(ao)}function ac(am,al){am=am||r;n.send("/router/GetWANStatus").success(function(an){L(ac,an.output.wanStatus==="Connected"||an.output.wanIPv6Status==="Connected",am,al)}).error(function(){L(ac,false,am,al)})}function i(){var am=(O)?V:0,al=(Y)?V:0;if(d){return}else{d=2}ac(r,am);T(ae,al,P.environment)}function u(al){if(!ak.isFunction(al)){throw"connectivityMonitorInit - Need to pass onChange callback"}O=undefined;Y=undefined;B=al;e()}function w(){if(y){clearInterval(y);y=null}}function e(){w();var al=(O)?W:c;y=setInterval(i,al);i()}function A(){return aa.logging.getLogKey(z)}function o(al){if(ak.isEmpty(al)||!ak.isObject(al)){throw"setOptions - Need to pass an object of options; call getOptions() to see format"}P=ak.merge(P,al);if(al.environment){J=K(P.environment)}x("info","Updated options",P)}function H(){P={environment:""}}function D(){return ak.cloneDeep(P)}H();return function(al){aa=al;x=aa.logging.setup(z,true);return{connectivity:{init:u,setOptions:o,resetOptions:H,getOptions:D,pause:w,resume:e,get Ofunction(){return O},set Ofunction(am){O=am;Z=am},get Yfunction(){return Y},set Yfunction(am){Y=am;m=am},get gfunction(){return g},get bfunction(){return b},get kfunction(){return k},get ffunction(){return f},getLatestCombinedLogs:A,testRouterOnline:ac,testCloudOnline:a,testCloudApi:E,testCloudAvailability:T},healthCheck:{startAll:ag,start:ai,stop:S,status:ab,getResults:Q,getErrorCode:q}}}}));