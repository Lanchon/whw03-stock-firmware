(function(){var P=$("#security-applet"),ai=P.find("#dmz"),q=P.find("#dmz-dhcpclienttable"),Z=P.find("#ddnsSettings"),B=Z.find("#ddnsProvider"),D=P.find("#ddns-DynDNS"),V=P.find("#ddns-No-IP"),az=null,n=RAINIER.ui.buildInputValidBalloon,i={description:"",externalPort:"",internalPort:"",protocol:"Both",internalServerLastOctet:"",isEnabled:true},ah={description:"",firstExternalPort:"",lastExternalPort:"",protocol:"Both",internalServerLastOctet:"",isEnabled:true},aa={description:"",firstTriggerPort:"",lastTriggerPort:"",firstForwardedPort:"",lastForwardedPort:"",isEnabled:true},u={description:"",isEnabled:true,portRanges:[{protocol:"Both",firstPort:"",lastPort:""}]},aD=null,v=null,R=null,f=false,b=true,h=true,L={validationType:"utf8LengthTooLong",maxLen:32,whiteSpace:false,isRequired:true},x={validCharSet:"numeric",minLen:1,maxLen:5,minVal:0,maxVal:65535,isRequired:true},ak={validCharSet:"numeric",minLen:1,maxLen:3,validationType:"validHost",isComposite:true,isBlankOnBlur:false};var N,S,ap,aJ;var y=P.find("#immutableTemplateSinglePortForwardingRow"),o=null,z=P.find("#immutableTemplatePortRangeForwardingRow"),r=null,aH=P.find("#immutableTemplatePortRangeTriggeringRow"),aC=null,au=P.find("#immutableTemplateIPv6FirewallRuleRow"),al=null,ax=RAINIER.ui.template.createTemplate(P.find("#templateClientRow tr"));var F={devices:[],firewall:{},ipv6firewallrules:{rules:[]},dmz:{},ddnssettings:{},ddnsproviders:{},ddnsstatus:{},singleportforwarding:{rules:[]},portrangeforwarding:{rules:[]},portrangetriggering:{rules:[]},wan:{},lanSettings:{}};var aw={firewall:{},ipv6firewallrulesSetup:{},ipv6firewallrules:{rules:[]},dmz:{},ddnssettings:{},singleportforwardingSetup:{},singleportforwarding:{rules:[]},portrangeforwardingSetup:{},portrangeforwarding:{rules:[]},portrangetriggeringSetup:{},portrangetriggering:{rules:[]}};var aK={"dynDNSSettings.isWildcardEnabled":"boolean","dynDNSSettings.isMailExchangeEnabled":"boolean","dynDNSSettings.mailExchangeSettings.isBackup":"boolean",externalPort:"number",internalPort:"number",isEnabled:"boolean",firstPort:"number",lastPort:"number",firstExternalPort:"number",lastExternalPort:"number",firstTriggerPort:"number",lastTriggerPort:"number",firstForwardedPort:"number",lastForwardedPort:"number"};var K={};var aA=function(aS){var a2,a3,a5,aQ,aV,aN,a7,aM,aT,a0,a6,aU;function aZ(a8){a2=a8.elTable;a3=a8.elAddButton;a5=a8.rowTemplate;aN=a8.emptyRecord;a7=a8.maxRecords;aM=a8.getRowData;aT=a8.setRowData;a0=a8.saveAction;a6=a8.rowAddValidation;aU=a8.isValidRow;a3.click(function(){if(a2.find("tr:last-child").index()<a7){aQ.rules.push(aN);aX(aN,true)}})}aZ(aS);function aR(ba,a9,a8){aQ=ba;aV=a9;if(!a8){RAINIER.ui.clearTbl(a2);$.each(aQ.rules,function(){var bb=$.extend({},this);aX(bb,false)})}}function aP(){$(this).addClass("edit");$(this).removeClass("hover")}function a4(){var a9=this.index()-1,a8=$(this);a8.removeClass("edit");if($.compare(aQ.rules[a9],aN)){aQ.rules.splice(a9,1);a8.remove()}else{RAINIER.binder.toDom(aT(aQ.rules[a9]),a8)}RAINIER.ui.inputBalloon.hide()}function aL(){var a8=this.index()-1;aQ.rules.splice(a8,1);$(this).hide();$(this).remove()}function aY(){var a9=this.index()-1,a8=$(this);if(aU&&!aU(a8)){return false}var ba=aM(a8);aQ.rules[a9]=ba;a8.removeClass("edit");RAINIER.binder.toDom(aT(ba),a8);return true}function aX(ba,a9){var a8=RAINIER.ui.template.createBlock(a5,aT(ba));if(a9){a8.addClass("edit")}if(a6){a6(a8)}a2.append(a8);a8.find("td").hover(function(){var bb=$(this).parent();if(!bb.hasClass("edit")){bb.addClass("hover")}},function(){$(this).parent().removeClass("hover")});a8.find(".edit").click(aP.bind(a8));a8.find(".delete").click(aL.bind(a8));a8.find(".save").click(aY.bind(a8));a8.find(".cancel").click(a4.bind(a8));RAINIER.util.trapEnter(a8.find("input[type=text]"))}function aO(){var a8=false;if(a2.find(".save:visible").length>0||!$.compare(aV,aQ)){a8=true}return a8}function a1(){a2.find(".save:visible").click();if(a0){a0()}}function aW(){var a8=true;if(aU){a2.find(".save:visible").closest("tr").each(function(ba,a9){a8=a8&&aU($(a9))})}return a8}return{hasChanges:aO,isValid:aW,save:a1,load:aR}};var w={onDdnsServiceChange:function(){var aL=B.val();P.find('label[id="ddnsstatus.status"]').empty();Z.removeClass("None No-IP DynDNS").addClass(aL);RAINIER.ui.fixIeForm(Z)},onDMZEnableChange:function(){var aL=ai.find("#dmz-enable").is(":checked");if(aL){if(ai.find("#sourceRestrictionSpecific").is(":checked")){ai.find("#sourceRestrictionSpecific").click()}else{ai.find("#sourceRestrictionAny").click()}if(ai.find("#destinationMACAddress").is(":checked")){ai.find("#destinationMACAddress").click()}else{ai.find("#destinationIPAddress").click()}}else{RAINIER.util.disable(ai.find("input[type=text]"),true)}RAINIER.util.disable(ai.find("#dmz-viewdhcpclienttable"),!aL);ai.find('[name="dmz.source"],[name="dmz.destination"]').prop("disabled",!aL).trigger("change")},onDMZSourceChange:function(){RAINIER.util.disable("#dmz-specified-range input",this.id==="sourceRestrictionAny");if(this.id==="sourceRestrictionSpecific"){K.dmz.sourceIpAddress.firstIPAddress.enable();K.dmz.sourceIpAddress.lastIPAddress.enable()}else{K.dmz.sourceIpAddress.firstIPAddress.disable();K.dmz.sourceIpAddress.lastIPAddress.disable()}},onDMZDestinationChange:function(){var aL=this.id==="destinationIPAddress";RAINIER.util.disable("#dmz-destinationIPAddress input",!aL);RAINIER.util.disable("#destination-mac-address input",aL)},onMACAddressSelected:function(){var aL={dmz:{destinationMACAddress:$(this).parents("tr").find('td[name="macAddress"]').text()}};RAINIER.binder.toDom(aL,ai,aK);ai.find("#destinationMACAddress").click();az.close()},onClose:function(){RAINIER.ui.MainMenu.closeApplet()},onApply:function(){A()},onSave:function(){A(true)},onSaveComplete:function(){RAINIER.ui.hideWaiting();if(h){if(b){w.onClose()}else{if(f){R.click()}}}}};var Y={ddns2:false};function l(aN,aM){var aO=parseInt(aN.val());var aL=parseInt(aM.val());return isNaN(aO)||isNaN(aL)||aO<=aL}function ad(aN,aL){var aM=RAINIER.util.dot2num(aL);return aM===0||aM>=RAINIER.util.dot2num(aN)}function C(aL){var aP=RAINIER.binder.fromDom(aL.parent()),aO=F.lanSettings.ipAddress.split("."),aM=aP[aL.attr("name")].split(".");for(var aN=0;aN<4;aN++){if(aO[aN]!==aM[aN]){return true}}return false}function A(aM){var aL=false;b=aM||false;h=true;switch(T()){case"firewall":if(p()){aL=true;if(H()){N.save();an()}}break;case"dmz":if(I()){aL=true;if(t()){ag()}}break;case"app-and-gaming":if(av()){aL=true;if(aI()){c()}}break}if(b&&!aL){w.onClose()}}function T(){return P.find("section.tab-section .tab-content:visible").attr("id")}function Q(){return P.find("section.tab-section .tab-content:visible .sub-tab-content:visible").attr("id")}function W(){var aL=false;switch(T()){case"firewall":aL=p();break;case"dmz":aL=I();break;case"app-and-gaming":aL=av();break}if(aL){aD.show()}return aL}function k(){switch(T()){case"firewall":aj();break;case"dmz":ae();break;case"app-and-gaming":X();break}}function G(aL){aL.add({action:"/jnap/firewall/GetFirewallSettings",data:{},cb:function(aM){if(aM.output){F.firewall=aM.output;F.firewall.enableIPSec=!F.firewall.blockIPSec;F.firewall.enablePPTP=!F.firewall.blockPPTP;F.firewall.enableL2TP=!F.firewall.blockL2TP;delete F.firewall.blockIPSec;delete F.firewall.blockPPTP;delete F.firewall.blockL2TP}else{}}});aL.add({action:"/jnap/firewall/GetIPv6FirewallRules",data:{},cb:function(aM){if(aM.output){F.ipv6firewallrules=aM.output;aw.ipv6firewallrules=$.extend(true,{},aM.output);al=RAINIER.ui.template.createTemplate(au.find("tbody").html().replace("{maxDescriptionLength}",F.ipv6firewallrules.maxDescriptionLength));aw.ipv6firewallrulesSetup.maxPortRanges=F.ipv6firewallrules.maxPortRanges;aw.ipv6firewallrulesSetup.maxDescriptionLength=F.ipv6firewallrules.maxDescriptionLength;aw.ipv6firewallrulesSetup.maxRules=F.ipv6firewallrules.maxRules;$.delAttr(F.ipv6firewallrules,"maxPortRanges","maxDescriptionLength","maxRules");$.delAttr(aw.ipv6firewallrules,"maxPortRanges","maxDescriptionLength","maxRules")}else{}}})}function aj(){RAINIER.binder.toDom(F,$("#firewall"),aK);aw.ipv6firewallrules=$.extend(true,{},F.ipv6firewallrules);N.load(aw.ipv6firewallrules,F.ipv6firewallrules)}function H(){return N.isValid()}function e(){N=aA({elTable:P.find("#ipv6firewallrules-list"),elAddButton:P.find("#add-ipv6firewall"),rowTemplate:al,emptyRecord:u,maxRecords:aw.ipv6firewallrulesSetup.maxRules,getRowData:function(aL){var aO={description:$.trim(aL.find('input[name="description"]').val()),ipv6Address:$.trim(aL.find(".ipv6firewall-ipv6Address").val()),isEnabled:aL.find(".rule-enabled").is(":checked")};var aP=$.trim(aL.find('select[name="protocol"]').val()),aN=$.trim(aL.find(".ipv6firewall-firstPort").val()),aM=$.trim(aL.find(".ipv6firewall-lastPort").val());aO.portRanges=[{protocol:aP,firstPort:parseInt(aN,10),lastPort:parseInt(aM,10)}];$.delAttr(aO,"isEnabledLabel","protocolLabel");return aO},setRowData:function(aM){var aL=$.extend(true,{},aM);aL.protocol=aM.portRanges[0].protocol;aL.protocolLabel=RAINIER.ui.common.strings.ipProtocol[aM.portRanges[0].protocol];aL.firstPort=aM.portRanges[0].firstPort;aL.lastPort=aM.portRanges[0].lastPort;aL.isEnabledLabel=aM.isEnabled?RAINIER.ui.common.strings["true"]:RAINIER.ui.common.strings["false"];delete aL.portRanges;return aL},rowAddValidation:function(aL){var aN={maxLen:63,validationType:"ipv6Address",isRequired:true},aM={};aM.description=n($.extend(true,{},L,{els:aL.find('input[name="description"]')}));aM.ipv6address=n($.extend(true,{},aN,{els:aL.find(".ipv6firewall-ipv6Address")}));aM.ports=n($.extend(true,{},x,{els:aL.find(".ipv6firewall-firstPort, .ipv6firewall-lastPort"),errors:[{test:l.curry(aL.find(".ipv6firewall-firstPort"),aL.find(".ipv6firewall-lastPort")),when:false,message:RAINIER.ui.validation.strings.security.portRangeError}]}));aL.data("checks",aM)},isValidRow:function(aL){var aM=aL.data("checks");return aM.description.isValid(true)&&aM.ipv6address.isValid(true)&&aM.ports.isValid(true)}});if(RAINIER.network.isBridgeMode()){P.find("#firewall-ipv4-enable").attr("disabled",true);P.find("#firewall-ipv6-enable").attr("disabled",true);P.find("#blockAnonymous").attr("disabled",true);P.find("#blockMulticast").attr("disabled",true);P.find("#blockNASRedirect").attr("disabled",true);P.find("#blockIDENT").attr("disabled",true)}aj()}function ab(){var aL=RAINIER.binder.fromDom($("#firewall"),aK);aw.firewall=aL.firewall}function p(){var aL=false;ab();if(!$.compare(aw.firewall,F.firewall)||N.hasChanges()){aL=true}return aL}function an(){var aL=RAINIER.jnap.Transaction({onComplete:w.onSaveComplete,disableDefaultJnapErrHandler:true});if(!$.compare(F.firewall,aw.firewall)){var aM=$.extend(true,{},aw.firewall),aO="/jnap/firewall/SetFirewallSettings";aM.blockIPSec=!aM.enableIPSec;aM.blockPPTP=!aM.enablePPTP;aM.blockL2TP=!aM.enableL2TP;delete aM.enableIPSec;delete aM.enablePPTP;delete aM.enableL2TP;aL.add({action:aO,data:aM,cb:function(aP){if(aP.result==="OK"){F.firewall=$.extend(true,{},aw.firewall)}else{if(aP.result!=="_AjaxError"){RAINIER.ajax().executeDefaultJnapErrorHandler(aP,aO)}h=false}}})}else{}if(N.hasChanges()){var aN="/jnap/firewall/SetIPv6FirewallRules";aL.add({action:aN,data:aw.ipv6firewallrules,cb:function(aP){if(aP.result==="OK"){F.ipv6firewallrules=$.extend(true,{},aw.ipv6firewallrules);N.load(aw.ipv6firewallrules,F.ipv6firewallrules,true)}else{if(aP.result!=="_AjaxError"){if(aP.result==="ErrorRulesOverlap"){RAINIER.ui.alert("",RAINIER.ui.validation.strings.errors[aP.result])}else{RAINIER.ajax().executeDefaultJnapErrorHandler(aP,aN)}}h=false}}})}else{}RAINIER.ui.showWaiting();aL.send()}function s(aL){aL.add({action:"/jnap/router/GetLANSettings",data:{},cb:function(aO){if(aO.result==="OK"){if(aO.output){var aN=aO.output.ipAddress.split(".");for(var aM=1;aM<=aO.output.minNetworkPrefixLength/8;aM++){ai.find('div[name="dmz.destinationIPAddress"]').find("input:nth-child("+aM+")").replaceWith("<label>"+aN[aM-1]+"</label>")}}else{}}else{}}});aL.add({action:"/jnap/firewall/GetDMZSettings",data:{},cb:function(aM){if(aM.result==="OK"){if(aM.output){F.dmz=aM.output;if(F.dmz.isDMZEnabled&&F.dmz.sourceRestriction&&F.dmz.sourceRestriction.firstIPAddress&&typeof F.dmz.sourceRestriction.lastIPAddress==="undefined"){F.dmz.sourceRestriction.lastIPAddress=F.dmz.sourceRestriction.firstIPAddress}}else{}}else{}}})}function ae(){RAINIER.binder.toDom(F,ai,aK);var aL=ai.find("#dmz-enable").is(":checked");if(aL){ai.find(":input:not(input[type=checkbox])").removeAttr("disabled");if(F.dmz.sourceRestriction){ai.find("#sourceRestrictionSpecific").click()}else{ai.find("#sourceRestrictionAny").click()}if(F.dmz.destinationIPAddress){ai.find("#destinationIPAddress").click()}else{ai.find("#destinationMACAddress").click()}}else{if(ai.find('input[name="dmz.source"]:checked').index()===-1){ai.find("#sourceRestrictionAny").attr("checked","checked")}if(ai.find('input[name="dmz.destination"]:checked').index()===-1){ai.find("#destinationIPAddress").attr("checked","checked")}RAINIER.util.disable(ai.find("input[type=text]"),true)}RAINIER.util.disable(ai.find('[name="dmz.source"],[name="dmz.destination"]'),!aL)}function d(){RAINIER.util.trapEnter(ai.find("input[type=text]"));ai.find("#sourceRestrictionAny").click(w.onDMZSourceChange);ai.find("#sourceRestrictionSpecific").click(w.onDMZSourceChange);ai.find("#destinationIPAddress").click(w.onDMZDestinationChange);ai.find("#destinationMACAddress").click(w.onDMZDestinationChange);ai.find("#dmz-enable").change(w.onDMZEnableChange);ai.find("#dmz-viewdhcpclienttable").click(function(){az.show()});q.find(".close-button").click(function(){az.close()});q.find(".refresh").click(function(){ac()})}function at(){var aN={minLen:2,maxLen:2,validationType:"macAddress",validCharSet:"hex",isRequired:true,isBlankOkOnBlur:false},aM={maxLen:3,validationType:"ipAddress",validCharSet:"numeric",isComposite:true},aL={sourceIpAddress:{}};aL.sourceIpAddress.firstIPAddress=n($.extend(true,{},aM,{elContainer:ai.find('div:[name="dmz.sourceRestriction.firstIPAddress"]'),allowZeroes:false}));aL.sourceIpAddress.lastIPAddress=n($.extend(true,{},aM,{elContainer:ai.find('div:[name="dmz.sourceRestriction.lastIPAddress"]'),allowZeroes:false}));aL.sourceIpAddress.range=n($.extend(true,{},{els:ai.find('div[name="dmz.sourceRestriction.firstIPAddress"], div[name="dmz.sourceRestriction.lastIPAddress"]'),errors:[{test:ad.curry(ai.find('div[name="dmz.sourceRestriction.firstIPAddress"]'),ai.find('div[name="dmz.sourceRestriction.lastIPAddress"]')),when:false,message:RAINIER.ui.validation.strings.security.ipRangeError}]}));aL.destinationIPAddress=n($.extend(true,{},ak,{elContainer:ai.find('div[name="dmz.destinationIPAddress"]'),elInputSubnetMask:RAINIER.util.fromPrefixLengthToSubnet(F.lanSettings.networkPrefixLength),elInputRouterIPAddress:F.lanSettings.ipAddress}));aL.destinationMACAddress=n($.extend(true,{},aN,{els:ai.find('#destination-mac-address input[type="text"]'),elContainer:ai.find("#destination-mac-address")}));K.dmz=aL}function t(){var aM=true,aL=K.dmz;if(ai.find("#dmz-enable").is(":checked")){if(ai.find("#sourceRestrictionSpecific").is(":checked")){aM=aM&&aL.sourceIpAddress.firstIPAddress.isValid(true);aM=aM&&aL.sourceIpAddress.lastIPAddress.isValid(true);aM=aM&&aL.sourceIpAddress.range.isValid(true)}if(ai.find("#destinationIPAddress").is(":checked")){aM=aM&&aL.destinationIPAddress.isValid(true)}else{aM=aM&&aL.destinationMACAddress.isValid(true)}}return aM}function a(){ai.find("#destination-mac-address").find(" > input").val("00").attr("defaultValue","00");ae();d();at()}function O(){if(ai.find("#dmz-enable").is(":checked")){aw.dmz={isDMZEnabled:true};if(ai.find("#sourceRestrictionSpecific").is(":checked")){$.extend(true,aw,RAINIER.binder.fromDom(ai.find('div[name="dmz.sourceRestriction.firstIPAddress"]').parent()))}if(ai.find("#destinationIPAddress").is(":checked")){$.extend(true,aw,RAINIER.binder.fromDom(ai.find('div[name="dmz.destinationIPAddress"]').parent()))}else{$.extend(true,aw,RAINIER.binder.fromDom(ai.find('div[name="dmz.destinationMACAddress"]').parent()))}}else{aw.dmz={isDMZEnabled:false}}}function I(){var aL=false;O();if(!$.compare(F.dmz,aw.dmz)){aL=true}return aL}function ag(){RAINIER.ui.showWaiting();RAINIER.jnap.send({action:"/jnap/firewall/SetDMZSettings",data:aw.dmz,cb:function(aL){if(aL.result==="OK"){F.dmz=$.extend(true,{},aw.dmz)}else{h=false}w.onSaveComplete()}})}function U(aM){RAINIER.ui.clearTbl(q);F.devices=aM;for(var aO=0;aO<F.devices.length;aO++){for(var aN=0;aN<F.devices[aO].data.connections.length;aN++){var aP={friendlyName:F.devices[aO].friendlyName(),ipAddress:F.devices[aO].data.connections[aN].ipAddress,macAddress:F.devices[aO].data.connections[aN].macAddress,select:RAINIER.ui.button.strings.select};if(F.devices[aO].data.connections[aN].wireless){aP.wireless=RAINIER.ui.common.strings.netType.wireless}else{aP.wireless=RAINIER.ui.common.strings.netType.lan}var aL=RAINIER.ui.template.createBlock(ax,aP);aL.find(".submit").click(w.onMACAddressSelected);q.find("tbody").append(aL)}}}function ac(){RAINIER.deviceManager.getDevices(U,{excludeAuthority:true},-1)}function aG(aL){aL.add({action:"/jnap/router/GetLANSettings",data:{},cb:function(aM){if(aM.result==="OK"){if(aM.output){F.lanSettings=aM.output}else{}}else{}}});aL.add({action:RAINIER.jnapActions.getWANStatus(),data:{},cb:function(aM){if(aM.result==="OK"){if(aM.output){F.wan=aM.output}else{}}else{}}});aL.add({action:"/jnap/ddns/GetDDNSSettings",data:{},cb:function(aM){if(aM.result==="OK"){if(aM.output){F.ddnssettings=aM.output}else{}}else{}}});if(Y.ddns2){aL.add({action:"/jnap/ddns/GetSupportedDDNSProviders",data:{},cb:function(aM){if(aM.result==="OK"){if(aM.output){F.ddnsproviders=aM.output.supportedDDNSProviders}else{}}else{}}})}aL.add({action:"/jnap/firewall/GetSinglePortForwardingRules",data:{},cb:function(aO){if(aO.result==="OK"){if(aO.output){F.singleportforwarding=aO.output;aw.singleportforwarding=$.extend(true,{},aO.output);var aN=F.lanSettings.ipAddress.split(".");for(var aM=1;aM<=F.lanSettings.minNetworkPrefixLength/8;aM++){$(y).find("span.spEdit > div.ip-input").find("input:nth-child("+aM+")").replaceWith("<label>"+aN[aM-1]+"</label>")}o=RAINIER.ui.template.createTemplate(y.find("tbody").html().replace("{maxDescriptionLength}",F.singleportforwarding.maxDescriptionLength));aw.singleportforwardingSetup.maxRules=F.singleportforwarding.maxRules;aw.singleportforwardingSetup.maxDescriptionLength=F.singleportforwarding.maxDescriptionLength;$.delAttr(F.singleportforwarding,"maxDescriptionLength","maxRules");$.delAttr(aw.singleportforwarding,"maxDescriptionLength","maxRules")}else{}}else{}}});aL.add({action:"/jnap/firewall/GetPortRangeForwardingRules",data:{},cb:function(aO){if(aO.result==="OK"){if(aO.output){F.portrangeforwarding=aO.output;aw.portrangeforwarding=$.extend(true,{},aO.output);var aN=F.lanSettings.ipAddress.split(".");for(var aM=1;aM<=F.lanSettings.minNetworkPrefixLength/8;aM++){$(z).find("span.spEdit > div.ip-input").find("input:nth-child("+aM+")").replaceWith("<label>"+aN[aM-1]+"</label>")}r=RAINIER.ui.template.createTemplate(z.find("tbody").html().replace("{maxDescriptionLength}",F.portrangeforwarding.maxDescriptionLength));aw.portrangeforwardingSetup.maxRules=F.portrangeforwarding.maxRules;aw.portrangeforwardingSetup.maxDescriptionLength=F.portrangeforwarding.maxDescriptionLength;$.delAttr(F.portrangeforwarding,"maxDescriptionLength","maxRules");$.delAttr(aw.portrangeforwarding,"maxDescriptionLength","maxRules")}else{}}else{}}});aL.add({action:"/jnap/firewall/GetPortRangeTriggeringRules",data:{},cb:function(aM){if(aM.result==="OK"){if(aM.output){F.portrangetriggering=aM.output;aw.portrangetriggering=$.extend(true,{},aM.output);aC=RAINIER.ui.template.createTemplate(aH.find("tbody").html().replace("{maxDescriptionLength}",F.portrangetriggering.maxDescriptionLength));aw.portrangetriggeringSetup.maxRules=F.portrangetriggering.maxRules;aw.portrangetriggeringSetup.maxDescriptionLength=F.portrangetriggering.maxDescriptionLength;$.delAttr(F.portrangetriggering,"maxDescriptionLength","maxRules");$.delAttr(aw.portrangetriggering,"maxDescriptionLength","maxRules")}else{}}else{}}});aL.add({action:RAINIER.jnapActions.getDDNSStatus(),data:{},cb:function(aM){if(aM.result==="OK"){if(aM.output){F.ddnsstatus=aM.output;if(F.ddnsstatus&&F.ddnsstatus.status){F.ddnsstatus.status=RAINIER.ui.common.strings.ddnsStatus[F.ddnsstatus.status]}}else{}}else{}}})}function X(){var aL=Y.ddns2?F.ddnsproviders:["DynDNS"],aM='<option value="{id}">{description}</option>';B.empty();$.each(aL,function(){var aN={id:this,description:RAINIER.ui.common.strings.ddnsProviders[this]};B.append(aM.formatObj(aN))});B.append(aM.formatObj({id:"None",description:RAINIER.ui.common.strings.disabled}));RAINIER.binder.toDom(F.wan,$("#ddns-common"),aK);switch(F.ddnssettings.ddnsProvider){case"DynDNS":RAINIER.binder.toDom(F.ddnssettings,D,aK);D.find("select").val(F.ddnssettings.dynDNSSettings.mode);if(F.ddnssettings.dynDNSSettings.isMailExchangeEnabled){if(F.ddnssettings.dynDNSSettings.mailExchangeSettings.isBackup){D.find("dynDNSSettings.mailExchangeSettings.isBackup").attr("checked","checked")}}if(F.ddnssettings.dynDNSSettings.isWildcardEnabled){D.find("dynDNSSettings.isWildcardEnabled").attr("checked","checked")}break;case"No-IP":RAINIER.binder.toDom(F.ddnssettings,V,aK);break;case"None":break}RAINIER.binder.toDom(F.ddnssettings,B,aK);B.val(F.ddnssettings.ddnsProvider);Z.removeClass("None No-IP DynDNS").addClass(F.ddnssettings.ddnsProvider);ao(F.ddnsstatus);aw.singleportforwarding=$.extend(true,{},F.singleportforwarding);S.load(aw.singleportforwarding,F.singleportforwarding);aw.portrangeforwarding=$.extend(true,{},F.portrangeforwarding);ap.load(aw.portrangeforwarding,F.portrangeforwarding);aw.portrangetriggering=$.extend(true,{},F.portrangetriggering);aJ.load(aw.portrangetriggering,F.portrangetriggering)}function aF(){B.change(w.onDdnsServiceChange);P.find("#ddns-update").click(function(){aq()});RAINIER.util.trapEnter(Z.find("input[type=text]"))}function M(){aE()}function aE(){var aR={maxLen:32,validCharSet:"ascii",whiteSpace:false,isRequired:true},aN={maxLen:32,validCharSet:"ascii",whiteSpace:false,isRequired:true},aQ={maxLen:128,validCharSet:"domainName",whiteSpace:false,isRequired:true},aO={maxLen:62,validCharSet:"ascii",whiteSpace:false,isRequired:false},aM={validationType:"email",maxLen:32,whiteSpace:false,isRequired:true},aP={maxLen:48,validCharSet:"domainName",whiteSpace:false,isRequired:true},aL={dyndns:{},noip:{}};aL.dyndns.username=n($.extend(true,{},aR,{els:D.find('input:[name="dynDNSSettings.username"]')}));aL.dyndns.password=n($.extend(true,{},aN,{els:D.find('input:[name="dynDNSSettings.password"]')}));aL.dyndns.hostName=n($.extend(true,{},aQ,{els:D.find('input:[name="dynDNSSettings.hostName"]')}));aL.dyndns.mailExchange=n($.extend(true,{},aO,{els:D.find('input:[name="dynDNSSettings.mailExchangeSettings.hostName"]')}));aL.noip.username=n($.extend(true,{},aR,{els:V.find('input:[name="noipSettings.username"]')}));aL.noip.password=n($.extend(true,{},aN,{els:V.find('input:[name="noipSettings.password"]')}));aL.noip.hostName=n($.extend(true,{},aQ,{els:V.find('input:[name="noipSettings.hostName"]')}));K.ddns=aL}function aI(){var aM=true,aL;switch(Q()){case"singleportforwarding":aM=aM&&S.isValid();break;case"portrangeforwarding":aM=aM&&ap.isValid();break;case"portrangetriggering":aM=aM&&aJ.isValid();break;default:switch(aw.ddnssettings.ddnsProvider){case"DynDNS":aL=K.ddns.dyndns;aM=aM&&aL.username.isValid(true);aM=aM&&aL.password.isValid(true);aM=aM&&aL.hostName.isValid(true);aM=aM&&aL.mailExchange.isValid(true);break;case"No-IP":aL=K.ddns.noip;aM=aM&&aL.username.isValid(true);aM=aM&&aL.password.isValid(true);aM=aM&&aL.hostName.isValid(true);break;default:break}break}return aM}function J(){function aL(aN){var aO=false,aM;switch(aN){case"portrangeforwarding":aM=P.find("#portrangeforwarding-list tbody tr");break;case"portrangetriggering":aM=P.find("#portrangetriggering-list tbody tr");break;default:aM=P.find("#singleportforwarding-list tbody tr");break}$.each(aM,function(){var aP=RAINIER.binder.fromDom($(this),aK),aQ=aM.filter(function(){var aR=RAINIER.binder.fromDom($(this),aK);if($.isEmptyObject(aP)||$.isEmptyObject(aR)){return 0}switch(aN){case"portrangeforwarding":return RAINIER.ui.validation.tests.doesRangeOverlap(aP.firstExternalPort,aP.lastExternalPort,aR.firstExternalPort,aR.lastExternalPort)&&(aP.protocol===aR.protocol||aR.protocol==="Both");case"portrangetriggering":return RAINIER.ui.validation.tests.doesRangeOverlap(aP.firstTriggerPort,aP.lastTriggerPort,aR.firstTriggerPort,aR.lastTriggerPort)||RAINIER.ui.validation.tests.doesRangeOverlap(aP.firstForwardedPort,aP.lastForwardedPort,aR.firstForwardedPort,aR.lastForwardedPort);default:return parseInt(aP.externalPort)===parseInt(aR.externalPort)&&(aP.protocol===aR.protocol||aR.protocol==="Both")}});if(aQ.length>1){aO=true}});return aO}S=aA({elTable:P.find("#singleportforwarding-list"),elAddButton:P.find("#add-singleportforwarding"),rowTemplate:o,emptyRecord:i,maxRecords:aw.singleportforwardingSetup.maxRules,saveAction:m,getRowData:function(aM){var aN=RAINIER.binder.fromDom(aM,aK);$.delAttr(aN,"isEnabledLabel","protocolLabel");return aN},setRowData:function(aN){var aM=$.extend(true,{},aN);aM.protocolLabel=RAINIER.ui.common.strings.ipProtocol[aN.protocol];aM.isEnabledLabel=(aN.isEnabled?RAINIER.ui.common.strings["true"]:RAINIER.ui.common.strings["false"]);return aM},rowAddValidation:function(aM){var aN={};aN.description=n($.extend(true,{},L,{els:aM.find('input[name="description"]')}));aN.ports=n($.extend(true,{},x,{els:aM.find(".forwarding-externalPort, .forwarding-internalPort")}));aN.internalServerIPAddress=n($.extend(true,{},ak,{elContainer:aM.find('.spEdit > div[name="internalServerIPAddress"]'),elInputSubnetMask:RAINIER.util.fromPrefixLengthToSubnet(F.lanSettings.networkPrefixLength),elInputRouterIPAddress:F.lanSettings.ipAddress,errors:[{test:C.curry(aM.find('.spEdit > div[name="internalServerIPAddress"]')),when:false,message:RAINIER.ui.validation.strings.invalidIPAddress}]}));aN.rulesOverlap=n($.extend(true,{},x,{els:aM.find(".forwarding-externalPort"),errors:[{test:aL,when:true,message:RAINIER.ui.validation.strings.errors.ErrorRulesOverlap}]}));aM.data("checks",aN)},isValidRow:function(aM){var aN=aM.data("checks");return aN.description.isValid(true)&&aN.ports.isValid(true)&&aN.rulesOverlap.isValid(true)&&aN.internalServerIPAddress.isValid(true)}});ap=aA({elTable:P.find("#portrangeforwarding-list"),elAddButton:P.find("#add-portrangeforwarding"),rowTemplate:r,emptyRecord:ah,maxRecords:aw.portrangeforwardingSetup.maxRules,saveAction:ay,getRowData:function(aM){var aN=RAINIER.binder.fromDom(aM,aK);$.delAttr(aN,"isEnabledLabel","protocolLabel");return aN},setRowData:function(aN){var aM=$.extend(true,{},aN);aM.protocolLabel=RAINIER.ui.common.strings.ipProtocol[aN.protocol];aM.isEnabledLabel=(aN.isEnabled?RAINIER.ui.common.strings["true"]:RAINIER.ui.common.strings["false"]);return aM},rowAddValidation:function(aM){var aN={};aN.description=n($.extend(true,{},L,{els:aM.find('input[name="description"]')}));aN.ports=n($.extend(true,{},x,{els:aM.find(".forwarding-firstExternalPort, .forwarding-lastExternalPort"),errors:[{test:l.curry(aM.find(".forwarding-firstExternalPort"),aM.find(".forwarding-lastExternalPort")),when:false,message:RAINIER.ui.validation.strings.security.portRangeError}]}));aN.internalServerIPAddress=n($.extend(true,{},ak,{elContainer:aM.find('.spEdit > div[name="internalServerIPAddress"]'),elInputSubnetMask:RAINIER.util.fromPrefixLengthToSubnet(F.lanSettings.networkPrefixLength),elInputRouterIPAddress:F.lanSettings.ipAddress,errors:[{test:C.curry(aM.find('.spEdit > div[name="internalServerIPAddress"]')),when:false,message:RAINIER.ui.validation.strings.invalidIPAddress}]}));aN.rulesOverlap=n($.extend(true,{},x,{els:aM.find(".forwarding-firstExternalPort, .forwarding-lastExternalPort"),errors:[{test:aL.curry("portrangeforwarding"),when:true,message:RAINIER.ui.validation.strings.errors.ErrorRulesOverlap}]}));aM.data("checks",aN)},isValidRow:function(aM){var aN=aM.data("checks");return aN.description.isValid(true)&&aN.ports.isValid(true)&&aN.rulesOverlap.isValid(true)&&aN.internalServerIPAddress.isValid(true)}});aJ=aA({elTable:P.find("#portrangetriggering-list"),elAddButton:P.find("#add-portrangetriggering"),rowTemplate:aC,emptyRecord:aa,maxRecords:aw.portrangetriggeringSetup.maxRules,saveAction:aB,getRowData:function(aM){var aN=RAINIER.binder.fromDom(aM,aK);$.delAttr(aN,"isEnabledLabel");return aN},setRowData:function(aN){var aM=$.extend(true,{},aN);aM.isEnabledLabel=(aN.isEnabled?RAINIER.ui.common.strings["true"]:RAINIER.ui.common.strings["false"]);return aM},rowAddValidation:function(aM){var aN={};aN.description=n($.extend(true,{},L,{els:aM.find('input[name="description"]')}));aN.triggerports=n($.extend(true,{},x,{els:aM.find(".triggering-firstTriggerPort, .triggering-lastTriggerPort"),errors:[{test:l.curry(aM.find(".triggering-firstTriggerPort"),aM.find(".triggering-lastTriggerPort")),when:false,message:RAINIER.ui.validation.strings.security.portRangeError}]}));aN.forwardedports=n($.extend(true,{},x,{els:aM.find(".triggering-firstForwardedPort, .triggering-lastForwardedPort"),errors:[{test:l.curry(aM.find(".triggering-firstForwardedPort"),aM.find(".triggering-lastForwardedPort")),when:false,message:RAINIER.ui.validation.strings.security.portRangeError}]}));aN.rulesOverlap=n($.extend(true,{},x,{els:aM.find(".triggering-firstTriggerPort, .triggering-lastTriggerPort, .triggering-firstForwardedPort, .triggering-lastForwardedPort"),errors:[{test:aL.curry("portrangetriggering"),when:true,message:RAINIER.ui.validation.strings.errors.ErrorRulesOverlap}]}));aM.data("checks",aN)},isValidRow:function(aM){var aN=aM.data("checks");return aN.description.isValid(true)&&aN.triggerports.isValid(true)&&aN.rulesOverlap.isValid(true)&&aN.forwardedports.isValid(true)}});X();aF();M()}function ao(aL){RAINIER.binder.toDom(aL,P.find("#ddns-common"),aK)}function aq(){E(ao)}function E(aL){RAINIER.jnap.send({action:RAINIER.jnapActions.getDDNSStatus(),data:{},cb:function(aM){if(aM.result==="OK"){if(aM.output){F.ddnsstatus=aM.output;if(F.ddnsstatus&&F.ddnsstatus.status){F.ddnsstatus.status=RAINIER.ui.common.strings.ddnsStatus[F.ddnsstatus.status]}}else{}if(typeof aL==="function"){aL(F.ddnsstatus)}}else{}}})}function j(){switch(Q()){case"singleportforwarding":case"portrangeforwarding":case"portrangetriggering":break;default:var aL=RAINIER.binder.fromDom(Z,aK);aw.ddnssettings={ddnsProvider:aL.ddnsProvider};switch(aL.ddnsProvider){case"DynDNS":aw.ddnssettings.dynDNSSettings=aL.dynDNSSettings;if(!aw.ddnssettings.dynDNSSettings.mailExchangeSettings.hostName){aw.ddnssettings.dynDNSSettings.isMailExchangeEnabled=false;delete aw.ddnssettings.dynDNSSettings.mailExchangeSettings}else{aw.ddnssettings.dynDNSSettings.isMailExchangeEnabled=true}break;case"No-IP":aw.ddnssettings.noipSettings=aL.noipSettings;break;default:break}break}}function av(){var aL=false;j();switch(Q()){case"singleportforwarding":aL=S.hasChanges();break;case"portrangeforwarding":aL=ap.hasChanges();break;case"portrangetriggering":aL=aJ.hasChanges();break;default:if(!$.compare(F.ddnssettings,aw.ddnssettings)){aL=true}break}return aL}function c(){switch(Q()){case"singleportforwarding":S.save();break;case"portrangeforwarding":ap.save();break;case"portrangetriggering":aJ.save();break;default:am();break}}function am(){RAINIER.ui.showWaiting();RAINIER.jnap.send({action:"/jnap/ddns/SetDDNSSettings",data:aw.ddnssettings,cb:function(aL){if(aL.result==="OK"){F.ddnssettings=$.extend(true,{},aw.ddnssettings)}else{h=false}w.onSaveComplete()}})}function m(){var aL="/jnap/firewall/SetSinglePortForwardingRules";RAINIER.ui.showWaiting();RAINIER.jnap.send({action:aL,data:aw.singleportforwarding,cb:function(aM){if(aM.result==="OK"){F.singleportforwarding=$.extend(true,{},aw.singleportforwarding);S.load(aw.singleportforwarding,F.singleportforwarding,true)}else{if(aM.result!=="_AjaxError"){if(aM.result==="ErrorRulesOverlap"){RAINIER.ui.alert("",RAINIER.ui.validation.strings.errors[aM.result])}else{RAINIER.ajax().executeDefaultJnapErrorHandler(aM,aL)}}h=false}w.onSaveComplete()},disableDefaultJnapErrHandler:true})}function ay(){var aL="/jnap/firewall/SetPortRangeForwardingRules";RAINIER.ui.showWaiting();RAINIER.jnap.send({action:aL,data:aw.portrangeforwarding,cb:function(aM){if(aM.result==="OK"){F.portrangeforwarding=$.extend(true,{},aw.portrangeforwarding);ap.load(aw.portrangeforwarding,F.portrangeforwarding,true)}else{if(aM.result!=="_AjaxError"){if(aM.result==="ErrorRulesOverlap"){RAINIER.ui.alert("",RAINIER.ui.validation.strings.errors[aM.result])}else{RAINIER.ajax().executeDefaultJnapErrorHandler(aM,aL)}}h=false}w.onSaveComplete()},disableDefaultJnapErrHandler:true})}function aB(){var aL="/jnap/firewall/SetPortRangeTriggeringRules";RAINIER.ui.showWaiting();RAINIER.jnap.send({action:aL,data:aw.portrangetriggering,cb:function(aM){if(aM.result==="OK"){F.portrangetriggering=$.extend(true,{},aw.portrangetriggering);aJ.load(aw.portrangetriggering,F.portrangetriggering,true)}else{if(aM.result!=="_AjaxError"){if(aM.result==="ErrorRulesOverlap"){RAINIER.ui.alert("",RAINIER.ui.validation.strings.errors[aM.result])}else{RAINIER.ajax().executeDefaultJnapErrorHandler(aM,aL)}}h=false}w.onSaveComplete()},disableDefaultJnapErrHandler:true})}function g(aL){G(aL);s(aL);aG(aL)}function ar(){e();a();J();RAINIER.event.fire("applet.loaded")}function af(){if(!RAINIER.shared.util.areServicesSupported(["/jnap/firewall/Firewall","/jnap/ddns/DDNS"])){RAINIER.event.fire("applet.unsupportedFirmware");return}Y.ddns2=RAINIER.shared.util.areServicesSupported(["/jnap/ddns/DDNS2"]);RAINIER.event.connect("tab.changed",function(aM,aN){switch(aN.destTabId){case"dmz":w.onDMZEnableChange();break;case"firewall":case"app-and-gaming":RAINIER.ui.fixIeForm("#"+aN.destTabId);break}});az=RAINIER.ui.dialog(q,{onShow:function(){ac()}});aD=RAINIER.ui.dialog($("#dialog-tabchange"),{onSubmit:function(){f=true;A(false)}});$("#dialog-tabchange #no-save").unbind("click");$("#dialog-tabchange #no-save").click(function(){aD.close();k();R.click()});v=RAINIER.ui.tabs.init({fireEvents:true,initialTab:$.cookie("initial-tab")});v.connect(function(aN,aM){if(aM.srcIdx>-1){R=aM.destTab;if(W()){aN.cancelEvent=true}}});v.fireInit();var aL=RAINIER.jnap.Transaction({onComplete:ar});g(aL);aL.send();P.find("footer .cancel").click(w.onClose);P.find("footer .submit").click(w.onSave);P.find("footer .apply").click(w.onApply)}af()}());