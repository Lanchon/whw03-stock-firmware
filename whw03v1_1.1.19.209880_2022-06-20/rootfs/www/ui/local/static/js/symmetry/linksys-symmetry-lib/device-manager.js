(function(a,b){if(typeof define==="function"&&define.amd){define(["jquery","lodash","./symmetry-jnap","./icon-rules"],b)}else{if(typeof module==="object"&&module.exports){module.exports=b(require("jquery"),require("lodash"),require("./symmetry-jnap"),require("./icon-rules"))}else{a.deviceManager=b(a.$,(a.lodash||a._),a.JNAP,a.iconRules)}}}(this,function(a5,ao,aq,br){var aC=false,X=[],z=0,aT=null,aj=null,ak=null,bc=0,i={},Y={};var J={},aB={},n={};var O=null,af=null,a=null,az=null,f=null;var u={byLogic:[],byEvents:[]};var aF={propDeviceName:"userDeviceName",propDeviceIcon:"userDeviceType",propDeviceLocation:"userDeviceLocation",propDeviceModelNumber:"userDeviceModelNumber",propDeviceManufacturer:"userDeviceManufacturer",propDeviceOS:"userDeviceOS"};var M="networkDevice",a6="guestNetworkDevice";var W=[40,25,10],T=[-50,-70,-90];var aE=5*1000;var aa=["dhcpReservation","signalStrengthIndex","radioSSID"];var aN=["subnetMask","minNetworkPrefixLength","maxNetworkPrefixLength","minAllowedDHCPLeaseMinutes","maxAllowedDHCPLeaseMinutes","maxDHCPReservationDescriptionLength"];var bp=["maxUsers","maxUsersLimit"];var ab="00:00:00:00:00:00";var I=["friendlyName","model.deviceType","model.description","model.manufacturer","model.modelNumber","model.hardwareVersion","unit.serialNumber","unit.firmwareVersion","unit.firmwareDate","unit.operatingSystem"];var N=["nodeType","model.modelNumber","model.manufacturer","unit.operatingSystem"];var l=/[^a-zA-Z0-9-]+|^-|-$/g;var G=/^Android$|^android-[a-fA-F0-9]{16}.*|^Android-\d+/i;var ay=/([\d.]+).+/;var p={general:ao.template("[ deviceManager - ${message} ]"),generalAddData:ao.template("[ deviceManager - ${message} - ${additionalData} ]"),actionFailed:ao.template("[ deviceManager - ${action} failed: ${result} ]"),actionFailedAddData:ao.template("[ deviceManager - ${action} failed: ${result} - ${additionalData} ]"),deleteOnlineDevice:ao.template("[ deviceManager - Cannot delete an Online Device - deviceID: ${deviceID} ]"),lastRevisionReset:ao.template("[ deviceManager - lastRevision # has dropped below sinceRevision, resetting current list - lastRevision: ${lastRevision}, sinceRevision: ${sinceRevision} ]"),startNodesConnectionPolling:ao.template("[ deviceManager - Starting NodesNetworkConnections Polling - timeout: ${timeout} ]"),jnapOptionsSet:ao.template("[ deviceManager - Setting jnapOptions for GetDevices call - jnapOptions: ${options} ]")};function aD(){if(!Y.GetDevices3&&this.model&&this.model.deviceType&&["mobile","phone","tablet"].indexOf(this.model.deviceType.toLowerCase())>-1&&!this.preferredConnection.wireless){return false}return this.isAuthority||this.connections.length>0}function a9(){return !ao.isEmpty(this.preferredConnection.wireless)}function bq(){var bs=Y.GuestNetwork4?"isGuest":"wireless.isGuest";return ao.result(this.preferredConnection,bs)||false}function av(){var bt=n.radios,bs="settings.ssid";if(this.isGuest){bt=aB.radios;bs="guestSSID"}return ao.result(ao.find(bt,{radioID:this.radioID}),bs)||"[SSID not found]"}function bh(){return ao.sortBy(this.connections,"wireless.radioID")[0]||{}}function aR(bu){var bt=this.properties,bs;if(ao.isEmpty(bu)){throw"getCustomProperty - Need to pass the name of the property"}for(bs=0;bs<bt.length;bs++){if(bt[bs].name===bu){return bt[bs].value}}}function h(){var bs=this,bt={};ao.each(aF,function(bu){bt[bu]=bs.getCustomProperty(bu)||null});return bt}function Q(){var bs=this.getCustomProperty(aF.propDeviceName),bv=ao.result(this,"friendlyName","")||"",bu=ao.result(this,"model.deviceType"),bt=ao.words(ao.result(this,"model.manufacturer"))[0],bx=ao.result(this,"model.modelNumber"),bw=ao.result(this,"unit.operatingSystem");if(!bs&&["Mobile","Phone","Tablet"].indexOf(bu)>-1&&G.test(bv)){if(bt&&bx){bs=bt+" "+bx}else{if(bw){bs=bw+" "+bu;if(bt){bs=bt+" "+bs}}}}return bs||this.friendlyName||bx||(this.isGuest?a6:M)}function aW(bs,bt){return ao.result(bs.trueValues,bt,null)}function au(bs,bv,bu){var bt=N.indexOf(bu)!==-1?aW(bs,bu):bu;return bs.getCustomProperty(aF[bv])||bt}function ac(){return au(this,"propDeviceLocation","")}function aV(){return au(this,"propDeviceModelNumber","model.modelNumber")}function aO(){return au(this,"propDeviceManufacturer","model.manufacturer")}function bn(){return au(this,"propDeviceOS","unit.operatingSystem")}function aL(){var bs=this;return X.filter(function(bt){return ao.find(bt.connections,function(bu){return bu.parentDeviceID===bs.deviceID})})}function S(bs,bt,bu){bs.push({name:bt,value:bu})}function a4(bu,bv,bw){var bt=bu.properties,bs;if(bu.getCustomProperty(bv)){for(bs=0;bs<bt.length;bs++){if(bt[bs].name===bv){bt[bs].value=bw;break}}}else{S(bt,bv,bw)}aA(bu.deviceID,bu)}function bi(bv,bw){var bt=this,bs=aq.Deferred(),bu={deviceID:bt.deviceID,propertiesToModify:[]};if(ao.isEmpty(bv)){throw"setCustomProperty - Need to pass the name of the property as first argument"}S(bu.propertiesToModify,bv,bw);aq.send("/devicelist/SetDeviceProperties",bu).success(function(){a4(bt,bv,bw);bs.resolve()}).error(function(bx){console.error(p.actionFailed({action:"SetDeviceProperties",result:JSON.stringify(bx,null,2)}));bs.reject(bx)});return bs}function aQ(bu){var bt=this,bs=aq.Deferred();if(ao.isEmpty(bu)){throw"setUserDefinedName - Need to pass a definedName"}bt.setCustomProperty(aF.propDeviceName,bu).success(function(){bs.resolve()}).error(function(bv){console.error(p.actionFailed({action:"setUserDefinedName",result:JSON.stringify(bv,null,2)}));bs.reject(bv)});return bs}function r(bu){var bt=this,bs=aq.Deferred();if(ao.isEmpty(bu)){throw"setUserDefinedIcon - Need to pass a definedIcon"}bt.setCustomProperty(aF.propDeviceIcon,bu).success(function(){bs.resolve()}).error(function(bv){console.error(p.actionFailed({action:"setUserDefinedIcon",result:JSON.stringify(bv,null,2)}));bs.reject(bv)});return bs}function q(bv,bw){var bt=this,bs=aq.Deferred(),bu={deviceID:bt.deviceID,propertiesToModify:[]};if(ao.isEmpty(bv)&&ao.isEmpty(bw)){throw"setUserDefinedNameAndIcon - Need to pass a definedName and/or a definedIcon"}if(!ao.isEmpty(bv)){S(bu.propertiesToModify,aF.propDeviceName,bv)}if(!ao.isEmpty(bw)){S(bu.propertiesToModify,aF.propDeviceIcon,bw)}aq.send("/devicelist/SetDeviceProperties",bu).success(function(){bu.propertiesToModify.forEach(function(bx){a4(bt,bx.name,bx.value)});bs.resolve()}).error(function(bx){console.error(p.actionFailed({action:"SetDeviceProperties",result:JSON.stringify(bx,null,2)}));bs.reject(bx)});return bs}function ax(bu){var bt=this,bs=aq.Deferred();if(ao.isEmpty(bu)){throw"setUserDefinedLocation - Need to pass a definedLocation"}bt.setCustomProperty(aF.propDeviceLocation,bu).success(function(){bs.resolve()}).error(function(bv){console.error(p.actionFailed({action:"setUserDefinedLocation",result:JSON.stringify(bv,null,2)}));bs.reject(bv)});return bs}function y(bw,bu,bt){var bv=this,bs=aq.Deferred(),bx={deviceID:bv.deviceID,propertiesToModify:[]};if(ao.isEmpty(bw)&&ao.isEmpty(bu)&&ao.isEmpty(bt)){throw"setUserDefinedNameAndIcon - Need to pass a definedName and/or a definedIcon"}if(!ao.isEmpty(bw)){S(bx.propertiesToModify,aF.propDeviceModelNumber,bw)}if(!ao.isEmpty(bu)){S(bx.propertiesToModify,aF.propDeviceManufacturer,bu)}if(!ao.isEmpty(bt)){S(bx.propertiesToModify,aF.propDeviceOS,bt)}aq.send("/devicelist/SetDeviceProperties",bx).success(function(){bx.propertiesToModify.forEach(function(by){a4(bv,by.name,by.value)});bs.resolve()}).error(function(by){console.error(p.actionFailed({action:"SetDeviceProperties",result:JSON.stringify(by,null,2)}));bs.reject(by)});return bs}function at(bv){var bt=this,bs=aq.Deferred(),bu={deviceID:bt.deviceID,propertiesToRemove:[bv]};if(ao.isEmpty(bv)){throw"removeCustomProperty - Need to pass a property name"}if(!bt.getCustomProperty(bv)){console.info(p.general({message:'removeCustomProperty - "'+bv+'" does not exist, exiting'}));bs.resolve();return}aq.send("/devicelist/SetDeviceProperties",bu).success(function(){var bx=bt.properties,bw;if(bt.getCustomProperty(bv)){for(bw=0;bw<bx.length;bw++){if(bx[bw].name===bv){bx.splice(bw,1);break}}}bs.resolve()}).error(function(bw){console.error(p.actionFailed({action:"SetDeviceProperties",result:JSON.stringify(bw,null,2)}));bs.reject(bw)});return bs}function c(){var bt=this,bs=aq.Deferred();if(bt.isOnline){console.error(p.deleteOnlineDevice({deviceID:bt.deviceID}));bs.reject()}aq.send("/devicelist/DeleteDevice",{deviceID:bt.deviceID}).success(function(){o(bt.deviceID);bs.resolve()}).error(function(bu){console.error(p.actionFailedAddData({action:"DeleteDevice",result:JSON.stringify(bu,null,2),additionalData:"deviceID: "+bt.deviceID||"--"}));bs.reject(bu)});return bs}function ae(){var bu=this,bv=bu.getCustomProperty(aF.propDeviceIcon),bs;if(bv&&bv!=="generic-device"){return bv}function bw(bB,by,bA){if(ao.isPlainObject(bB)){ao.each(bB,function(bD,bC){if(by){bC=by+"."+bC}return bw(bD,bC,bA)})}else{var bz=ao.result(bu,by),bx=false;if((ao.isRegExp(bB)&&bB.test(bz))||bB===bz){bx=true}bA.push(bx);return bx}}function bt(bx){var by=[];bw(bx.test,"",by);return by.indexOf(false)===-1}bs=ao.result(ao.find(br,bt),"iconClass");if(ao.isPlainObject(bs)&&bs.lookup){bs=ao.result(this,bs.lookup);bs="router-"+bs.toLowerCase()}return bs}function d(bu){var bt=ao.cloneDeep(bu);var bs={deviceName:Q,deviceIcon:ae};if(!bt.properties){bt.properties=[]}if(!bt.getCustomProperty){s(bt,null,bs);bt.getCustomProperty=aR.bind(bt);w(bt)}return bt}function ag(bs){if(ao.isEmpty(bs)&&!ao.isPlainObject(bs)){throw"findDeviceIcon - Need to pass an object to examine"}bs=d(bs);return bs.deviceIcon}function b(bs){if(ao.isEmpty(bs)&&!ao.isPlainObject(bs)){throw"findDeviceName - Need to pass an object to examine"}bs=d(bs);return bs.deviceName}function C(){return ao.find(J.dhcpSettings.reservations,{macAddress:this.macAddress})}function D(){var bu=this.deviceName.replace(l,""),bt=bu,bs=1;while(ao.find(J.dhcpSettings.reservations,{description:bt})){bt=bu+bs++}return bt}function ap(){var bu=this,bt=0,bv,bs;if(!Y.NodesNetworkConnections&&Y.GetDevices3&&Y.NodesSetup){return 0}bv=bu.signalDecibels>0?W:T;bs=ao.find(bv,function(bw){return bu.signalDecibels>bw});if(bs){bt=3-ao.indexOf(bv,bs)}return bt}function bm(bt){var bs=aq.Deferred();bt=ao.omit(bt,aN);bt.dhcpSettings=ao.omit(bt.dhcpSettings,bp);bt.dhcpSettings.leaseMinutes=parseInt(bt.dhcpSettings.leaseMinutes,10);aq.send("/router/SetLANSettings",bt).success(function(){J.dhcpSettings.reservations=ao.cloneDeep(bt.dhcpSettings.reservations);bs.resolve()}).error(function(bu){console.error(p.actionFailed({action:"SetLANSettings",result:JSON.stringify(bu,null,2)}));bs.reject(bu)});return bs}function A(bx,bz){var bu=this,bs=aq.Deferred(),by=ao.cloneDeep(J),bw=bu.dhcpReservation,bv={macAddress:bu.macAddress,ipAddress:bx,description:bz};function bt(bA){return bA.macAddress!==bu.macAddress&&bA.description===bz}if(ao.isEmpty(bx)){throw"reserveDHCPAddress - Need to pass the ipAddress to use as first argument"}if(ao.isEmpty(bz)){bv.description=bu.getUniqueDHCPDescription()}else{if(ao.find(J.dhcpSettings.reservations,bt)){throw"reserveDHCPAddress - Description specified in use by another Reservation, must be unique"}}if(bu.isGuest){throw"reserveDHCPAddress - Cannot operate on a Guest device"}if(bw&&!ao.isEqual(bw,bv)){bw=ao.find(by.dhcpSettings.reservations,{macAddress:bu.macAddress});bw=ao.merge(bw,bv)}else{if(!bw){by.dhcpSettings.reservations.push(bv)}}if(!ao.isEqual(J,by)){bm(by).success(function(){a0(bu.deviceID);bs.resolve(bv)}).error(function(bA){console.error(p.actionFailed({action:"reserveDHCPAddress",result:JSON.stringify(bA,null,2)}));bs.reject(bA)})}else{bs.resolve()}return bs}function aI(){var bt=this,bs=aq.Deferred(),bw=ao.cloneDeep(J),bv=this.dhcpReservation,bu;if(bt.isGuest){throw"removeDHCPReservation - Cannot operate on a Guest device"}if(bv){bu=ao.findIndex(bw.dhcpSettings.reservations,{macAddress:this.macAddress});bw.dhcpSettings.reservations.splice(bu,1);bm(bw).success(function(){a0(bt.deviceID);bs.resolve()}).error(function(bx){console.error(p.actionFailed({action:"removeDHCPReservation",result:JSON.stringify(bx,null,2)}));bs.reject(bx)})}else{bs.resolve()}return bs}function an(){var bt;if(Y.GetDevices3){var bs=ao.find(this.knownInterfaces,{macAddress:this.macAddress});if(!ao.isEmpty(bs)){bt=bs.interfaceType}}if(!bt||bt==="Unknown"){bt=this.wireless?"Wireless":"Wired"}return bt}function m(){var bs=null;if(this.parentDeviceID){bs=E(this.parentDeviceID)}return bs}function x(bt,bs){bs=N.indexOf(bt)!==-1?bs.trueValues:bs;return ao.result(bs,bt,null)}function K(bt,bv,bs){var bu=x(bv,bs||bt);ao.set(bt,bv,bu)}function a8(bs){I.forEach(function(bt){K(bs,bt)})}function bb(bt){var bs={};I.forEach(function(bu){ao.set(bs,bu,ao.result(bt,bu))});return bs}function aJ(){var bt=[],bs=ao.sortBy(ao.cloneDeep(X),"deviceName");bs.forEach(a8);bs.forEach(function(by,bv){var bw=by.deviceID;if(bt.indexOf(bw)===-1){var bA=bb(by);bt.push(bw);if(bA.friendlyName&&["Computer","GameConsole"].indexOf(ao.result(by,"model.deviceType"))!==-1){var bz=ao.filter(ao.reject(bs,function(bB){return bt.indexOf(bB.deviceID)!==-1}),bA);if(bz.length){var bx=[],bu=[];by.showMatchDetails=true;by.matchedDeviceIDs=[];bz.forEach(function(bC){var bB=bC.deviceID,bD=ao.findIndex(bs,{deviceID:bB});bC.showMatchDetails=true;bx.push(bD);by.matchedDeviceIDs.push(bB)});bt=ao.union(bt,by.matchedDeviceIDs);bu=ao.pullAt(bs,bx);bu.forEach(function(bC,bB){bs.splice(bv+bB+1,0,bC)})}}}});return bs}function F(){var bs=ao.result(this.trueValues,"nodeType");if(Y.GetDevices3&&!ao.isEmpty(bs)&&ao.result(this,"unit.firmwareVersion")){return bs}else{if(!Y.GetDevices3&&(!ao.isEmpty(this.deviceLocation)||this.model.modelNumber==="WHW03")){if(this.isAuthority){return"Master"}else{return"Slave"}}}return""}function w(bs){if(!bs.trueValues){bs.trueValues={};N.forEach(function(bt){ao.set(bs.trueValues,bt,ao.result(bs,bt))})}}function s(bu,bv,bt){var bs,bw;for(bs in bt){if(bt.hasOwnProperty(bs)){bw=bt[bs];if(ao.isPlainObject(bw)){if(!bu[bs]){bu[bs]={}}s(bu[bs],bv||bu,bw)}else{Object.defineProperty(bu,bs,{get:bv?bw.bind(bv):bw,configurable:true,enumerable:true})}}}}function aM(bt){var bs={deviceName:Q,deviceIcon:ae,deviceLocation:ac,isGuest:bq,isOnline:aD,preferredConnection:bh,nodeType:F,model:{modelNumber:aV,manufacturer:aO},unit:{operatingSystem:bn}};bt=ao.cloneDeep(bt);w(bt);s(bt,null,bs);bt.hasChanges=false;if(!bt.knownMACAddresses){bt.knownMACAddresses=[];if(bt.knownInterfaces){bt.knownMACAddresses=ao.map(bt.knownInterfaces,"macAddress")}}bt.getCustomProperty=aR.bind(bt);bt.getUserDefinedProperties=h.bind(bt);bt.setCustomProperty=bi.bind(bt);bt.setUserDefinedName=aQ.bind(bt);bt.setUserDefinedIcon=r.bind(bt);bt.setUserDefinedNameAndIcon=q.bind(bt);bt.setUserDefinedLocation=ax.bind(bt);bt.setUserDefinedModelAndUnitData=y.bind(bt);bt.removeCustomProperty=at.bind(bt);bt.deleteOfflineDevice=c.bind(bt);if(Y.GetDevices3){bt.getChildDevices=aL.bind(bt)}return bt}function aU(bt){var bs={deviceID:function(){return this.macAddress},isGuest:function(){return true},isOnline:a9,isAuthority:function(){return false},deviceName:Q,deviceIcon:ae,knownMACAddresses:function(){return[this.macAddress]},model:function(){return{deviceType:""}},preferredConnection:bh};bt=ao.cloneDeep(bt);s(bt,null,bs);bt.friendlyName=a6;bt.hasChanges=false;bt.connections=[{macAddress:bt.macAddress,ipAddress:bt.ipAddress,wireless:{}}];bt.getCustomProperty=function(){};return bt}function aS(bt,bu){var bs={deviceID:function(){return bu.deviceID},deviceName:function(){return bu.deviceName},dhcpReservation:C,knownInterfaces:function(){return bu.knownInterfaces},interfaceType:an};bt=ao.cloneDeep(bt);s(bt,null,bs);bt.reserveDHCPAddress=A.bind(bt);bt.removeDHCPReservation=aI.bind(bt);bt.getUniqueDHCPDescription=D.bind(bt);if(Y.GetDevices3){bt.getParentDevice=m.bind(bt)}return bt}function ad(bs){var bt={signalStrengthIndex:ap,radioSSID:av};bs=ao.cloneDeep(bs);s(bs,null,bt);if(!bs.radioID){bs.radioID="RADIO_"+bs.band}return bs}function aA(bu,bs){var bt;bs.hasChanges=true;for(bt=0;bt<X.length;bt++){if(X[bt].deviceID===bu){X[bt]=bs;break}}}function o(bt){var bs;for(bs=0;bs<X.length;bs++){if(X[bs].deviceID===bt){if(u.byLogic.indexOf(bt)===-1){u.byLogic.push(bt)}X.splice(bs,1);break}}}function a0(bt){var bs=E(bt);bs.hasChanges=true}function bj(bs){return bs.hasChanges}function a2(bt,bu){var bs=ao.omit(bt.wireless,aa);if(!ao.isEqual(bs,bu||{})){bt.wireless=ao.merge(bt.wireless||{},bu);if(!bt.wireless.hasOwnProperty("signalStrengthIndex")){bt.wireless=ad(bt.wireless)}return true}return false}function am(bt){var bs,bv,bu,bw;a5.when(O,af,f).done(function(){if(!Y.NodesNetworkConnections){bs=ao.result(bt,"output.connections")}else{bs=ao.flatten(ao.map(ao.result(bt,"output.nodeWirelessConnections"),"connections"))}X.forEach(function(bA){var by=bA.backhaulInfo;bw=Y.GetGuestNetworkClients&&bA.isGuest;if(by&&bA.connections.length){var bz=ao.compact([ao.find(bA.connections,{ipAddress:by.ipAddress})]),bx=bA.connections[0];bA.connections=bz.length?bz:bA.connections;bx.parentDeviceID=ao.result(R(ao.result(by,"parentIPAddress","--")),"deviceID",bx.parentDeviceID);if(!bz.length){bx.ipAddress=by.ipAddress}}bA.connections.forEach(function(bD,bC){if(!(bw||bD.hasOwnProperty("dhcpReservation"))){bD=aS(bD,bA);bA.hasChanges=true}if(by){var bF;if(by.connectionType==="Wireless"){bF=by.wirelessConnectionInfo;bF.radioID=bF.radioID.replace(ay,"RADIO_$1GHz")+(bF.radioID==="5GH"?"_2":"");bF.signalDecibels=bF.stationRSSI;if(a2(bD,bF)){bA.hasChanges=true}}if(Y.GetDevices3){var bB=ao.findIndex(bA.knownInterfaces,{macAddress:bD.macAddress}),bE={macAddress:bD.macAddress,interfaceType:by.connectionType};if(by.connectionType==="Wireless"){bE.band=bF.radioID.indexOf("2.4")!==-1?"2.4GHz":"5GHz"}if(bB!==-1){bA.knownInterfaces=[bE]}else{bA.knownInterfaces.unshift(bE)}bA.knownMACAddresses=ao.map(bA.knownInterfaces,"macAddress")}}else{if(!ao.isEmpty(bs)){bv=ao.find(bs,{macAddress:bD.macAddress});if(bv){if(a2(bD,bv.wireless)){bA.hasChanges=true}}else{if(bw&&!ao.isEmpty(bD.wireless)){bD.wireless={};bA.hasChanges=true}}}}if(Y.GetDevices3&&Y.NodesSetup&&bA.isOnline&&!by){bu=ao.find(bA.knownInterfaces,{macAddress:bD.macAddress,interfaceType:"Wireless"});if(bu&&!ao.result(bv,"wireless")){bD.wireless={signalStrengthIndex:0,band:bu.band};bA.hasChanges=true}}if(bA.hasChanges){bA.connections[bC]=bD}})});az.resolve()})}function B(bt,bw,bs){var bA=aq.transaction(),bz=bw||aq.Deferred(),bu=H(),by={},bv,bx;if(bs){console.info(p.general({message:"Ignoring cache for current Device Manager update"}));by={supportedForCaching:{"/networkconnections/GetNetworkConnections":false,"/networkconnections/GetNetworkConnections2":false,"/devicelist/GetDevices":false,"/devicelist/GetDevices3":false,"/guestnetwork/GetGuestNetworkClients":false,"/router/GetDHCPClientLeases":false,"/nodes/networkconnections/GetNodesWirelessNetworkConnections":false,"/nodes/diagnostics/GetBackhaulInfo":false}}}else{if(!ao.isEmpty(bu.supportedForCaching)){by={supportedForCaching:bu.supportedForCaching};console.info(p.jnapOptionsSet({options:JSON.stringify(by,null,2)}))}}a5.when(O,af,a,az,f).done(function(){O=aq.Deferred();af=aq.Deferred();a=aq.Deferred();az=aq.Deferred();f=aq.Deferred();if(!aC){aY()}if(bu.doGetNetworkConnectionsInMainUpdate){if(!Y.NodesNetworkConnections){bA.add("/networkconnections/GetNetworkConnections").success(am).error(function(bB){console.error(p.actionFailed({action:"GetNetworkConnections",result:JSON.stringify(bB,null,2)}))})}}else{am()}bA.add("/devicelist/GetDevices",{sinceRevision:i.disableRevision?0:bt}).success(function(bB){var bD=bB.output,bC=bD.deletedDeviceIDs||[];z=bD.revision;bD.devices.forEach(function(bE){bx=aM(bE);bv=E(bE.deviceID);if(bv){aA(bv.deviceID,bx)}else{bx.hasChanges=true;X.push(bx)}});bC=ao.difference(bC,ao.map(bD.devices,"deviceID"));if(bC.length){u.byEvents=ao.union(u.byEvents,bC);bC.forEach(o)}O.resolve()}).error(function(bB){console.error(p.actionFailed({action:"GetDevices",result:JSON.stringify(bB,null,2)}))});if(aB.isGuestNetworkEnabled){if(Y.GetGuestNetworkClients){bA.add("/guestnetwork/GetGuestNetworkClients").success(function(bB){var bC=bB.output.clients,bE=false,bD;bC.forEach(function(bF){bx=aU(bF);bv=E(bx.deviceID);if(!bv){bx.hasChanges=true;X.push(bx)}});be().forEach(function(bF){bE=bC.some(function(bG){return bG.macAddress===bF.macAddress});if(!bE){o(bF.deviceID)}else{for(bD=0;bD<X.length;bD++){bx=X[bD];if(!bx.isGuest&&bx.knownMACAddresses.indexOf(bF.macAddress)!==-1){if(bx.isOnline){o(bF.deviceID)}else{o(bx.deviceID)}break}}}});af.resolve()}).error(function(bB){console.error(p.actionFailed({action:"GetGuestNetworkClients",result:JSON.stringify(bB,null,2)}))})}else{af.resolve()}bA.add("/router/GetDHCPClientLeases").success(function(bB){a5.when(O,af).done(function(){bB.output.leases.forEach(function(bC){bx=V(bC.macAddress);if(bx&&bx.isGuest&&bx.deviceName===a6){bx.friendlyName=bC.hostName;bx.hasChanges=true}});a.resolve()})}).error(function(bB){console.error(p.actionFailed({action:"GetDHCPClientLeases",result:JSON.stringify(bB,null,2)}))})}else{af.resolve();a.resolve()}bA.send(by).success(function(){var bB=false;if(Y.NodesDiagnostics2){aq.send("/nodes/diagnostics/GetBackhaulInfo").success(function(bC){a5.when(O).done(function(){bC.output.backhaulDevices.forEach(function(bE){var bD=E(bE.deviceUUID);if(bD){bD.backhaulInfo=ao.cloneDeep(bE)}});f.resolve()})}).error(function(bC){console.error(p.actionFailed({action:"GetBackhaulInfo",result:JSON.stringify(bC,null,2)}));f.resolve()})}else{f.resolve()}if(bu.doGetNetworkConnectionsInMainUpdate&&Y.NodesNetworkConnections){aq.send("/nodes/networkconnections/GetNodesWirelessNetworkConnections",{},by).success(am).error(function(bC){console.error(p.actionFailedAddData({action:"GetNodesWirelessNetworkConnections",result:JSON.stringify(bC,null,2),additionalData:"Continuing"}));am()})}a5.when(O,af,a,az,f).done(function(){if(z<bt){console.warn(p.lastRevisionReset({lastRevision:z,sinceRevision:bt}));X.forEach(function(bC){if(u.byEvents.indexOf(bC.deviceID)===-1){u.byEvents.push(bC.deviceID)}});ba();B(0,bz,true);return}ao.forEachRight(X,function(bC){if(!bC.isAuthority&&bC.knownMACAddresses.indexOf(ab)>-1){ao.remove(bC.knownMACAddresses,function(bD){return bD===ab});if(bC.knownMACAddresses.length===0){o(bC.deviceID)}}});if(bt>0&&(bu.notifyOnEveryPoll||X.some(bj)||u.byLogic.length)){bB=true}bz.resolve({devices:X,doNotify:bB})})}).error(function(bB){console.error(p.actionFailed({action:"updateDeviceList - Transaction failed",result:JSON.stringify(bB,null,2)}));e();bz.reject(bB)})});return bz}function Z(){X.forEach(function(bs){bs.hasChanges=false});u.byLogic=[]}function bg(){ao.forEachRight(u.byEvents,function(bu,bt){if(!ao.isEmpty(E(bu))){u.byEvents.splice(bt,1)}});var bs={changedDevices:ao.filter(X,"hasChanges"),deletedDeviceIDs:ao.union(u.byLogic,u.byEvents)};Z();return bs}function bo(bt,bu){var bs=aq.Deferred();bu=bu||false;if(!i.doPolling||bt){B(bt?0:z,null,bu).success(function(bv){bs.resolve(bv.devices)}).error(function(bv){console.error(p.actionFailed({action:"getDevices",result:JSON.stringify(bv,null,2)}));bs.reject(bv)})}else{bs.resolve(X)}return bs}function ai(){var bs=aq.Deferred();B(z).success(function(){bs.resolve(bg())}).error(function(bt){console.error(p.actionFailed({action:"getDeviceChanges",result:JSON.stringify(bt,null,2)}));bs.reject(bt)});return bs}function E(bt){var bs,bu;if(ao.isEmpty(bt)){throw"getDeviceByID - Need to pass a Device ID"}bs=ao.find(X,{deviceID:bt});if(!bs){bu=ao.map(ao.chunk(bt.toUpperCase().substr(24),2),function(bv){return bv.join("")}).join(":");if(bu){bs=V(bu)}}return bs}function R(bt){var bs,bv,bu;if(ao.isEmpty(bt)){throw"getDeviceByIPAddress - Need to pass an IP Address"}for(bs=0;bs<X.length;bs++){bu=X[bs];for(bv=0;bv<bu.connections.length;bv++){if(bu.connections[bv].ipAddress===bt){return bu}}}}function V(bt){var bs,bv,bu;if(ao.isEmpty(bt)){throw"getDeviceByMACAddress - Need to pass a MAC Address"}for(bs=0;bs<X.length;bs++){bu=X[bs];for(bv=0;bv<bu.knownMACAddresses.length;bv++){if(bu.knownMACAddresses[bv]===bt){return bu}}}}function ba(){X=[];z=0}function P(){return ao.find(X,{isAuthority:true})}function bf(){return X.filter(function(bs){return !bs.isGuest&&!bs.isAuthority})}function be(){return X.filter(function(bs){return bs.isGuest})}function a7(){return ao.find(X,{nodeType:"Master"})||P()}function g(){return X.filter(function(bs){return bs.nodeType==="Slave"})}function ah(){var bt=a7(),bs=g();if(bt){bs.unshift(bt)}return bs}function aK(bu){var bs=aq.Deferred(),bt;bu=bu.replace(/:/g,"").toLowerCase();aq.send("/nodes/setup/GetConnectedNodesDeviceID",{}).success(function(bv){bt=ao.find(bv.output.deviceIDs,function(bw){return ao.endsWith(bw.toLowerCase(),bu)});bs.resolve(bt)}).error(function(bv){console.error(p.actionFailed({action:"GetConnectedNodesDeviceID",result:JSON.stringify(bv,null,2)}));bs.reject(bv)});return bs}function bk(bs){var bt=a7(),bv=g(),bu=ao.map(bv,"deviceName");if(ao.isEmpty(bs)){throw"isNodeNameUnique - Need to pass a deviceName string to check against"}if(bt){bu.push(bt.deviceName)}return bu.indexOf(bs)===-1}function t(bs,bt){aq.send("/nodes/networkconnections/GetNodesWirelessNetworkConnections",{}).success(function(bu){am(bu);bs(bg());aT=setTimeout(function(){t(bs,bt)},bt)}).error(function(bu){console.error(p.actionFailed({action:"GetNodesWirelessNetworkConnections",result:JSON.stringify(bu,null,2)}))})}function a3(bt,bu){var bs=aq.Deferred();if(Y.NodesNetworkConnections){aq.send("/nodes/networkconnections/RefreshNodesWirelessNetworkConnections",{}).success(function(){console.info(p.general({message:"Starting NodesNetworkConnections Refresh"}));if(!aT){if(!bu||bu<aE){bu=aE}console.info(p.startNodesConnectionPolling({timeout:bu}));aT=setTimeout(function(){t(bt,bu)},bu)}bs.resolve()}).error(function(bv){console.error(p.actionFailed({action:"RefreshNodesWirelessNetworkConnections",result:JSON.stringify(bv,null,2)}));bs.reject(bv)})}else{bs.resolve()}return bs}function ar(){if(aT){console.info(p.general({message:"Stopping NodesNetworkConnections polling"}));clearTimeout(aT);aT=null}}function al(bt){var bs=aq.Deferred(),bv=aq.Deferred(),bu=[];function bw(bx){bu.push(bx);o(bx)}if(!ao.isEmpty(bt)&&!ao.isArray(bt)){throw"deleteOfflineDevices - First argument should be an array of DeviceIDs"}if(ao.isEmpty(bt)){bt=[];X.forEach(function(bx){if(!bx.isOnline){bt.push(bx.deviceID)}})}bt.forEach(function(by,bx){aq.send("/devicelist/DeleteDevice",{deviceID:by}).success(function(){bw(by)}).error(function(bz){console.error(p.actionFailedAddData({action:"Error trying to delete Device by ID",result:JSON.stringify(bz,null,2),additionalData:by}));if(bz.result==="ErrorUnknownDevice"){bw(by)}}).always(function(){if(bx===bt.length-1){bv.resolve()}})});a5.when(bv).done(function(){bs.resolve(bu)});return bs}function bd(){return X.filter(function(bs){return !bs.isOnline})}function aZ(){bl();aj=setInterval(function(){B(z).success(function(bs){if(bs.doNotify){if(i.notifyWithChanges){ak.notify(bg())}else{ak.notify(bs.devices)}}}).error(function(bs){console.error(p.actionFailed({action:"Device Polling failed",result:JSON.stringify(bs,null,2)}));ak.notify(bs)})},i.pollingFrequencyMs)}function bl(){bc=0;if(aj){clearInterval(aj);aj=null}}function aH(bs){var bt=i.pollingFrequencyMs;if(ao.isEmpty(bs)||!ao.isObject(bs)){throw"setOptions - Need to pass an object of options; call getOptions() to see format"}i=ao.merge(i,bs);console.info(p.general({message:"Updated options: "+JSON.stringify(i,null,2)}));if(i.doPolling){bc--;if(bc>0){return}bc=0;if(!ak){ak=aq.Deferred()}if(z>0){if(!aj){aZ()}else{if(bt!==i.pollingFrequencyMs){bl();aZ()}}}}else{if(i.doPolling===false){bc++;bl();return}}return ak}function aP(){console.warn(p.general({message:"Resetting options back to base"}));bl();ar();i={disableRevision:false,doPolling:false,doGetNetworkConnectionsInMainUpdate:true,notifyWithChanges:false,notifyOnEveryPoll:false,pollingFrequencyMs:0,supportedForCaching:{}}}function H(){return ao.cloneDeep(i)}function j(){if(!aC){aY()}return ao.cloneDeep(Y)}function v(){var bs=aq.Deferred();aq.send("/guestnetwork/GetGuestNetworkSettings",{}).success(function(bt){if(!bt.output.isGuestNetworkEnabled&&aB.isGuestNetworkEnabled){be().forEach(function(bu){o(bu.deviceID)})}aB=bt.output;if(!aq.isServiceSupported("/guestnetwork/GuestNetwork3")){aB.radios=[{radioID:"RADIO_2.4GHz",guestSSID:aB.guestSSID}]}if(aq.isServiceSupported("/guestnetwork/GuestNetwork4")){Y.GetGuestNetworkClients=aB.isGuestNetworkACaptivePortal}bs.resolve()}).error(function(bt){console.error(p.actionFailed({action:"GetGuestNetworkSettings",result:JSON.stringify(bt,null,2)}));bs.reject(bt)});return bs}function a1(){var bs=aq.Deferred();aq.send("/wirelessap/GetRadioInfo",{}).success(function(bt){n=bt.output;bs.resolve()}).error(function(bt){console.error(p.actionFailed({action:"GetRadioInfo",result:JSON.stringify(bt,null,2)}));bs.reject(bt)});return bs}function k(){var bs=aq.Deferred();aq.send("/router/GetLANSettings",{}).success(function(bt){J=bt.output;bs.resolve()}).error(function(bt){console.error(p.actionFailed({action:"GetLANSettings",result:JSON.stringify(bt,null,2)}));bs.reject(bt)});return bs}function aX(){Y={GetDevices3:false,GuestNetwork4:false,GetGuestNetworkClients:false,NodesSetup:false,NodesNetworkConnections:false,NodesDiagnostics2:false}}function aY(){Y.GetDevices3=aq.isServiceSupported("/devicelist/DeviceList4");Y.GuestNetwork4=aq.isServiceSupported("/guestnetwork/GuestNetwork4");Y.GetGuestNetworkClients=aq.isServiceSupported("/guestnetwork/GuestNetwork2")||aq.isServiceSupported("/guestnetwork/GuestNetwork3");Y.NodesSetup=aq.isServiceSupported("/nodes/setup/Setup");Y.NodesNetworkConnections=aq.isServiceSupported("/nodes/networkconnections/NodesNetworkConnections");Y.NodesDiagnostics2=aq.isServiceSupported("/nodes/diagnostics/Diagnostics2")}function L(){var bs=aq.Deferred(),bt=v(),bv=a1(),bu=k();a5.when(bt,bv,bu).done(function(){bs.resolve()}).fail(function(bw){console.error(p.actionFailed({action:"updateRouterSettings",result:JSON.stringify(bw,null,2)}));bs.reject(bw)});return bs}function U(){J={dhcpSettings:{reservations:[]}};aB={radios:[]};n={radios:[]}}function e(){O=null;af=null;a=null;az=null;f=null}function aw(bs){var bv=a5.Deferred();function bt(bw){return ao.result(bw,"state","[Not a Deferred]")}console.warn(p.general({message:"Entered Reset"}));var bu=function(){console.warn(p.general({message:"Resetting Device Manager"}));e();aq.unsubscribe("/guestnetwork/SetGuestNetworkSettings",v);aq.unsubscribe("/wirelessap/SetRadioSettings",a1);aq.unsubscribe("/router/SetLANSettings",k);ba();U();aX();aP();aC=false;bv.resolve()};if(bs){console.warn(p.generalAddData({message:"Forcing Reset (states of: dfdGetDevices, dfdGetGuests, dfdGetClientLeases, dfdGetNetworkConnections, dfdGetBackhaulInfo)",additionalData:bt(O)+" : "+bt(af)+" : "+bt(a)+" : "+bt(az)+" : "+bt(f)}));bu()}else{a5.when(O,af,a,az,f).done(function(){bu()})}return bv}function aG(){var bs=aq.Deferred();if(aC){console.warn(p.actionFailed({action:"init",result:"Device Manager has already been initialized, skipping"}));return bs.resolve([])}aC=true;aY();L().success(function(){if(i.doPolling){bs.success(aZ)}B(0).success(function(bt){bs.resolve(bt.devices)}).error(function(bt){console.error(p.actionFailed({action:"init - updateDeviceList",result:JSON.stringify(bt,null,2)}));bs.reject(bt)});aq.subscribe("/guestnetwork/SetGuestNetworkSettings",v);aq.subscribe("/wirelessap/SetRadioSettings",a1);aq.subscribe("/router/SetLANSettings",k)}).error(function(bt){console.error(p.actionFailed({action:"init - updateRouterSettings",result:JSON.stringify(bt,null,2)}));bs.reject(bt)});return bs}U();aP();return{init:aG,reset:aw,updateRouterSettings:L,setOptions:aH,getOptions:H,getRouterSupport:j,resetOptions:aP,clearDeviceList:ba,clearDeviceChanges:Z,findDeviceIcon:ag,findDeviceName:b,getDevices:bo,getDeviceChanges:ai,getCurrentChanges:bg,getDeviceByID:E,getDeviceByIPAddress:R,getDeviceByMACAddress:V,getCurrentAuthorityDevice:P,getMainNetworkDevices:bf,getGuestNetworkDevices:be,getOfflineDevices:bd,deleteOfflineDevices:al,matchDevices:aJ,objectToDevice:d,nodes:{getMaster:a7,getSlaves:g,getAll:ah,isNameUnique:bk,getUUIDByMACAddress:aK,startNetworkConnectionsPolling:a3,stopNetworkConnectionsPolling:ar}}}));