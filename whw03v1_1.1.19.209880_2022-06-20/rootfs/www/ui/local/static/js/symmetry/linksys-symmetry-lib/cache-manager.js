(function(a,b){if(typeof define==="function"&&define.amd){define(["jquery","lodash","jnap-js/jnap"],b)}else{if(typeof module==="object"&&module.exports){module.exports=b(require("jquery"),require("lodash"),require("@linksys/jnap-js").JNAP)}else{a.cacheManager=b(a.$,(a.lodash||a._),a.JNAP)}}}(this,function(d,q,k){var j="",o;q.flatMap=q.flatMap||q.collect;var a={"/router/SetLANSettings":["/router/GetLANSettings"],"/wirelessap/SetRadioSettings":["/wirelessap/GetRadioInfo"],"/wirelessap/SetRadioSettings2":["/wirelessap/GetRadioInfo"],"/wirelessap/SetRadioSettings3":["/wirelessap/GetRadioInfo"]};function p(s){if(s){delete k.cache.data[s]}else{d.each(k.cache.data,function(t){delete k.cache.data[t]})}if(j){n(j)}}function c(t){if(!t){throw"You need to pass a serialNumber to loadCache, or things will break"}if(t!==j){var s=JSON.parse(localStorage.getItem("dataCache"));k.cache.data=s&&s[t]||{};j=t}if(q.size(k.cache.data)===0){return false}return true}function n(t){var s=JSON.parse(localStorage.getItem("dataCache"))||{};s[t]=k.cache.data;localStorage.setItem("dataCache",JSON.stringify(s))}function r(t){t=t||j;var s=JSON.parse(localStorage.getItem("dataCache"));return s[t]}function i(){var s=JSON.parse(localStorage.getItem("dataCache"));return s}function g(s){return a[s]||[]}window.getCache=r;function l(t){var s={supportedForCaching:{"/core/GetDeviceInfo":true},defaultCacheExpirationTime:120000,cacheSettings:{},disableCacheClearing:false};k.setOptions(s);o=t;k.cache={load:c,save:n,get:r,getAll:i,clear:p,data:{}}}function h(s){return s.replace(k.getOptions().baseUrl,"")}function b(w,s,v,u){var t;var x;if(!u){for(t=0;t<w.length;t++){x=h(w[t].action);if(x==="/core/GetDeviceInfo"){u=s.responses[t].output.serialNumber}}}for(t=0;t<w.length;t++){x=h(w[t].action);if(v[x]&&u){k.cache.data[x]=s.responses[t];k.cache.data[x].cachedAt=Date.now()}}}function m(v,z,s){var A=k.getOptions(),t=A.cacheSettings,w=A.appCaching,y=A.defaultCacheExpirationTime,x=t[v]&&t[v].useOnStartup||true,u=t[v]&&t[v].expirationTime||y;z=z||{};s=s||{};if(z[v]&&w==="forceCache"||!q.isEmpty(s)){return s[v]?s[v]:z[v]}else{if(w==="refreshCache"||!z[v]||!z[v].cachedAt||Date.now()-z[v].cachedAt>u&&!(w==="useCache"&&x)){return null}else{return z[v]}}}function f(x,s,u,v){var y,A={result:"OK",responses:[]};var z=false;for(y=0;y<x.length;y++){var w=h(x[y].action);if(u[w]){var t=m(w,u,v);if(!t){z=true}}if(!s[w]||!u[w]||z){return null}A.responses.push(u[w])}return A}function e(v,x,D,A){D=D||{};if(D.serialNumber&&!D.cacheOverrides){c(D.serialNumber)}var t=k.getOptions(D).supportedForCaching;var C=q.result(D,"cacheOverrides")?D.cacheOverrides:k.cache.data;var u=null;var y=[];if(!k.getOptions(D).disableCacheClearing){if(v==="/core/Transaction"){var s=q.flatMap(q.map(x,"action"),h),w=q.intersection(s,q.keys(a));y=q.flatten(q.flatMap(w,g))}else{y=g(v)}}if(v==="/core/Transaction"){u=f(A,t,C,D.cacheOverrides)}else{if(t[v]){u=m(v,C,D.cacheOverrides)}}if(u){if(window.DEBUG){}var B=k.Deferred();u.fromCache=true;B.resolve(u);return B}var z=k.actionSupportedByRouter(v,D);return o(z,x,D).success(function(E){if(!q.isEmpty(y)){console.warn("[ cacheManager - clearing caches: "+y+" ]");y.forEach(function(G){p(G)})}if(!q.result(D,"cacheOverrides")){var F=D.serialNumber;if(v==="/core/GetDeviceInfo"&&t[v]){F=E.output.serialNumber;c(F)}else{if(k.cache.data["/core/GetDeviceInfo"]){F=k.cache.data["/core/GetDeviceInfo"].output.serialNumber}}if(t[v]&&F){k.cache.data[v]=E;k.cache.data[v].cachedAt=Date.now()}if(v==="/core/Transaction"){b(A,E,t,F)}if(F){n(F)}}})}return{init:l,send:e}}));