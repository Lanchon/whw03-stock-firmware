var Account=(function(){var a=RAINIER.ui.build,d=RAINIER.ui.inputBalloon;function f(){if(!window.location.search){return null}var b=RAINIER.util.getUrlVars(window.location.href);if(!b.client_id){return null}return[{name:"X-Linksys-Client-Type-Id",value:b.client_id}]}var c=(function(){var l={none:0,removeRestriction:1,enableMethod:2,disableMethod:4};var q=null,h=l.none,p=null,g="";function j(){return"Basic "+window.btoa(RAINIER.shared.util.getCiscoHNClientID()+":eac870f5bb094297bbc9d84e745d72da")}function i(u){var v={challengeType:"push-code",communicationMethod:p.method,verificationToken:g};RAINIER.cloud.send({url:"/cloud/authorization-service/oauth/challenge",type:"POST",headers:[{name:"Authorization",value:j()}],data:v,cb:function(w){if(typeof u.cb==="function"){u.cb(w)}},cbError:function(x){var w=RAINIER.util.parseJSON(x.responseText);if(w){if(w.code==="INVALID_VERIFICATION_TOKEN"){if(w.message==="Verification "+g+" has expired"){if(h===l.removeRestriction){t(p,u.cb)}}}else{if(w.code==="EXCEED_MAX_RETRIES"){if(h===l.removeRestriction){t(p,u.cb)}else{if(h===l.enableMethod){RAINIER.cloud.send({url:"/cloud/user-service/rest/accounts/self/mfa-methods",type:"POST",cb:function(y){g=y.verificationToken;i({cb:u.cb})}})}}}else{if(typeof u.cbError==="function"){u.cbError(x)}else{return false}}}}}})}function m(u){if(!q){q=RAINIER.ui.dialog($("#mfa-resent"));$("#mfa-resent .close-button").unbind("click").click(function(){q.close();if(u&&typeof u.cb==="function"){u.cb()}})}RAINIER.ui.showMasterWaiting();i({cb:function(){RAINIER.ui.hideMasterWaiting(function(){q.show({onSubmit:function(){if(u&&typeof u.cb==="function"){u.cb()}}})})}})}function t(v,u){p=v;h=l.removeRestriction;RAINIER.cloud.send({url:"/cloud/user-service/rest/sessions/"+$.cookie("user-auth-token")+"/restrictions/MFA",type:"DELETE",cb:function(w){g=w.verificationToken;i({cb:u})},cbError:function(x){var w=RAINIER.util.parseJSON(x.responseText);if(w&&w.errors&&w.errors[0].error.code==="INVALID_SESSION_TOKEN"){RAINIER.network.signOut()}else{return false}}})}function o(u){var w=$("#mfa-resend"),v=RAINIER.ui.dialog(w,{onSubmit:function(){m(u)}});w.find(".close-button").unbind("click").click(function(){v.close();if(typeof u.onCancel==="function"){u.onCancel()}});v.show()}function r(w){var v=RAINIER.ui.dialog($("#mfa-retry-limit"),{cancelClose:true,onSubmit:function(){v.close();if(h===l.removeRestriction){t(p,x)}else{if(h===l.enableMethod){RAINIER.cloud.send({url:"/cloud/user-service/rest/accounts/self/mfa-methods",type:"POST",cb:function(y){g=y.verificationToken;i({cb:x})}})}}}});function x(){var y=RAINIER.ui.dialog($("#mfa-retry-limit-resent"),{onSubmit:u});$("#mfa-retry-limit-resent .close-button").unbind("click").click(function(){y.close();u()});y.show()}function u(){if(w&&typeof w.cb==="function"){w.cb()}}$("#mfa-retry-limit .close-button").unbind("click").click(function(){v.close();if(w&&typeof w.cbCancel==="function"){w.cbCancel()}});v.show()}function b(u){RAINIER.ui.showMasterWaiting();if(h===l.removeRestriction){RAINIER.cloud.send({url:"/cloud/authorization-service/oauth/token?grant_type="+encodeURIComponent("http://linksyssmartwifi.com/grant/mfa-validate"),type:"POST",contentType:"application/x-www-form-urlencoded",headers:[{name:"Authorization",value:j()}],data:{verification_token:g,refreshable:u.saveRefreshToken||false,otp:u.otp.trim()},cb:function(w){var y=!_.isEmpty($.cookie("force-pw-update")),x=w.access_token;if(y){Account.forceCloudPWChange(x);return}var v=RAINIER.shared.util.getURLParameter("return_path")||"/ui/dynamic/home.html";$.cookie("user-auth-token",x,{expires:null,path:"/"});if(u.saveRefreshToken){$.cookie("user-refresh-token",w.refresh_token,{expires:30,path:"/"})}window.location.replace(v)},cbError:function(x){var w=RAINIER.util.parseJSON(x.responseText),v;RAINIER.ui.hideMasterWaiting();if(w){if(w.error==="verification_token_expired"){v=RAINIER.ui.dialog($("#mfa-expired"),{onSubmit:m});$("#mfa-expired .close-button").unbind("click").click(function(){v.close()});v.show()}else{if(w.error==="otp_retry_exceeded"){r({cbCancel:u.cbCancel})}else{if(typeof u.cbError==="function"){u.cbError(w.error)}else{return false}}}}else{return false}}})}}function s(u){if(!$.cookie("user-refresh-token")&&typeof u.cbError==="function"){u.cbError();return}RAINIER.cloud.send({url:"/cloud/authorization-service/oauth/token",type:"POST",contentType:"application/x-www-form-urlencoded",headers:[{name:"Authorization",value:j()}],data:{grant_type:"refresh_token",refresh_token:$.cookie("user-refresh-token")},cb:function(v){$.cookie("user-auth-token",v.access_token,{expires:null,path:"/"});if(v&&v.refresh_token){$.cookie("user-refresh-token",v.refresh_token,{expires:30,path:"/"})}if(typeof u.cb==="function"){u.cb(v)}else{window.location.reload()}},cbError:function(v){RAINIER.shared.util.deleteCookie("user-refresh-token");if(typeof u.cbError==="function"){u.cbError(v)}}})}function n(u){p=u.method;h=l.enableMethod;RAINIER.ui.showMasterWaiting();RAINIER.cloud.send({url:"/cloud/user-service/rest/accounts/self/mfa-methods",type:"POST",cb:function(v){g=v.verificationToken;i({cb:function(){RAINIER.ui.hideMasterWaiting(function(){var z=$("#mfa-validate"),x=z.find(".mfa-email-method"),A=z.find(".mfa-sms-method"),w=z.find("#mfa-code-input"),y=z.find("#mfa-error-incorrect");w.val("");y.hide();if(p.method==="EMAIL"){x.find("span").text(p.target);A.hide();x.show()}else{if(p.method==="SMS"){A.find("span").text(p.target);x.hide();A.show()}}var B=RAINIER.ui.dialog(z,{cancelClose:true,onSubmit:function(){RAINIER.ui.showMasterWaiting();y.hide();RAINIER.cloud.send({url:"/cloud/user-service/rest/accounts/self/mfa-validate",type:"POST",data:{verificationToken:g,otp:w.val()},cb:function(C){RAINIER.ui.hideMasterWaiting();if(typeof u.cb==="function"){u.cb(C)}B.close()},cbError:function(E){var D=RAINIER.util.parseJSON(E.responseText);RAINIER.ui.hideMasterWaiting();if(D){if(["INVALID_VERIFICATION_TOKEN","INCORRECT_OTP","INVALID_PARAMETER"].indexOf(D.code)>-1){y.show()}else{if(D.code==="EXCEED_MAX_RETRIES"){B.close();r({cb:function(){w.val("");y.hide();B.show()},cbCancel:u.cbCancel})}else{if(D.code==="INVALID_VERIFICATION_EXPIRED"){var C=RAINIER.ui.dialog($("#mfa-expired"),{onSubmit:function(){n(u)}});$("#mfa-expired .close-button").unbind("click").click(function(){if(typeof u.cbCancel==="function"){u.cbCancel()}C.close()});B.close();C.show()}else{return false}}}}else{return false}}})}});z.find(".close-button").unbind("click").click(function(){if(typeof u.cbCancel==="function"){u.cbCancel()}B.close()});z.find("#mfa-code-resend").unbind("click").click(function(){B.close();o({cb:function(){B.show()},onCancel:function(){B.show()}});return false});B.show()})}})}})}function k(u){p=u.method;h=l.disableMethod;RAINIER.ui.showMasterWaiting();RAINIER.cloud.send({url:"/cloud/user-service/rest/accounts/self/mfa-methods/"+p.id,type:"DELETE",cb:function(v){RAINIER.ui.hideMasterWaiting();if(typeof u.cb==="function"){u.cb(v)}}})}return{removeRestriction:t,resend:o,verifyOTP:b,refreshToken:s,enableMethod:n,disableMethod:k}})();return{create:function(g,h,b){RAINIER.cloud.send({url:"/cloud/user-service/rest/v2/accounts/u",type:"POST",data:g,cb:h,cbError:function(j){var i=RAINIER.util.parseJSON(j.responseText);if(i&&i.errors){if(b){return b(i.errors[0].error)}else{RAINIER.ui.alert(i.errors[0].error.message);return false}}}})},validate:function(g,k,i){var h={verification:{status:"ACCEPTED",parameters:[]}};var j={};function b(){window.top.location.href="http://"+window.location.host.replace("linksysremotemanagement.com","linksyssmartwifi.com")+"/ui/dynamic/password-reset.html"}if(i){h.verification.parameters.push(i)}j["X-Linksys-Client-Type-Id"]=RAINIER.shared.util.getCiscoHNClientID();j.accept="application/json";jQuery.ajax({headers:j,type:"PUT",data:JSON.stringify(h),url:"/cloud/user-service/rest/v2/verifications/"+g+"/status/",success:k,contentType:"application/json; charset=UTF-8",dataType:"json",error:function(m){var l=RAINIER.util.parseJSON(m.responseText);if(m.status===409&&m.statusText==="Conflict"||m.status===404&&m.statusText==="Not Found"){if(l.errors&&l.errors[0]&&l.errors[0].error.code==="PASSWORD_REUSED"){RAINIER.ui.alert(RAINIER.login.strings.changePasswordReusedPassword,RAINIER.login.strings.changePasswordTokenInvalidTitle)}else{RAINIER.ui.alert(RAINIER.login.strings.changePasswordTokenInvalid,RAINIER.login.strings.changePasswordTokenInvalidTitle,function(){window.top.location.href="/"})}}else{if(m.status===400&&m.statusText==="Bad Request"){if(l.errors[0].error.code==="PASSWORD_COMPLEXITY_ERROR"){RAINIER.ui.alert(RAINIER.createAccount.strings.passwordRequirementsMessage,RAINIER.createAccount.strings.passwordRequirementsHeader,b)}else{RAINIER.ui.alert(RAINIER.login.strings.changePasswordTokenExpired,RAINIER.login.strings.changePasswordTokenInvalidTitle,b)}}else{var n=window.RAINIER.login.strings.unexpectedCloudError;if(l&&l.errors){n=l.errors[0].error.message}RAINIER.ui.alert(n)}}}})},loginErrorHandler:function(m){RAINIER.ui.wait(false);var g=null,o=RAINIER.login.strings,h=null,j=$("#username"),i=RAINIER.util.parseJSON(m.responseText);if(!i||!i.errors){RAINIER.ui.alert(window.RAINIER.login.strings.unexpectedCloudError);return false}h=i.errors[0].error;switch(m.status){case 400:switch(h.code){default:g=o.invalidCloudLogin;break}break;case 403:switch(h.code){case"ACCOUNT_DISABLED":g=o.accountDisabled;break;case"ACCOUNT_PENDING":function n(p){$("#email-not-validated #email-not-validated-content").removeClass("none sending sent failed");$("#email-not-validated #email-not-validated-content").addClass(p)}function l(){$("#email-not-validated .cancel, #email-not-validated .submit").removeAttr("disabled")}var k;var b={cancelClose:true,onSubmit:function(){var p={};p["X-Linksys-Client-Type-Id"]=RAINIER.shared.util.getCiscoHNClientID();p.accept="application/json";n("sending");$("#email-not-validated .cancel, #email-not-validated .submit").attr("disabled","disabled");jQuery.ajax({headers:p,type:"POST",data:JSON.stringify({verification:{type:"ACCOUNT_CREATION",parameters:[{parameter:{name:"username",value:$("#username").val()}}]}}),url:"/cloud/user-service/rest/verifications",success:function(){n("sent");$("#email-not-validated .cancel").removeAttr("disabled");setTimeout(function(){k.close()},4000)},contentType:"application/json; charset=UTF-8",dataType:"json",error:function(){n("failed");l()}})}};k=RAINIER.ui.dialog($("#email-not-validated"),b);n("none");l();k.show();return true;case"INVALID_ACCOUNT_CREDENTIALS":g=o.invalidCloudLogin;break;case"ACCOUNT_LOCKED_OUT":window.top.location.href="account-lockout.html";return true}break;case 404:switch(h.code){case"ACCOUNT_NOT_FOUND":g=o.accountNotFound;break}break;case 417:switch(h.code){case"ACCOUNT_SECURITY_LOCK":window.top.location.href="account-security-lock.html";return true}break}if(g!==null){d.add({els:j,isBlankOkOnBlur:false,balloonContent:a.DIV({"class":"flow"},[a.SPAN({"class":"icon warning"}),a.SPAN({"class":"msg"},g.replace("{username}",j.val()))])},true);d.hide(8000);$("#login-failed-tip").show();return true}return false},forceCloudPWChange:function(b){var g="password-reset"+($.cookie("force-pw-update")==="full"?"":"-simple");$.cookie("force-pw-update",null,{path:"/"});$.cookie("user-auth-token",null,{expires:null,path:"/"});window.location.replace(g+".html?req=1&verificationToken="+b)},onlineLogin:function e(j,h,i,g){if(!i){i=Account.loginErrorHandler}RAINIER.ui.wait();var b=f();$.cookie("current-network-id",null,{path:"/"});RAINIER.cloud.send({url:"/cloud/user-service/rest/v2/sessions",headers:b,type:"POST",data:{session:{account:{username:j,password:h}}},cb:function(l){var k=l.session.token;$.cookie("admin-auth",null,{path:"/"});$.cookie("user-name",$("#remember-me:checked").length>0?j:"",{expires:new Date().addYears(10),path:"/"});if(!RAINIER.shared.util.isCloudPasswordValid(j,h)){$.cookie("user-email",j,{path:"/"});$.cookie("force-pw-update","full",{path:"/"})}$.cookie("user-auth-token",k,{expires:null,path:"/"});RAINIER.network.discoverAuthority(function(){if(RAINIER.network.isBehindAuthority()&&!RAINIER.network.getAuthorityNetworkID()){var n=$.cookie("rp");$.cookie("rp",null,{path:"/"});if(n){n=window.atob(n);RAINIER.deviceManager.getAuthorityDevice(function m(o){RAINIER.jnap.send({action:"/jnap/ownednetwork/SetNetworkOwner",data:{ownerSessionToken:$.cookie("user-auth-token"),friendlyName:o.friendlyName()},cb:function(p){if(p.result==="OK"){RAINIER.network.discoverAuthority(function(){if(RAINIER.network.isBehindAuthority()){if(!RAINIER.network.getAuthorityNetworkID()){window.location.replace("/ui/dynamic/welcome.html")}else{RAINIER.network.setRemoteSetting(true,function(){RAINIER.shared.ui.authenticatedGoToIndex(k)})}}else{window.location.replace("/ui/dynamic/no-associated-router.html")}})}else{window.location.replace("/ui/dynamic/welcome.html")}},disableDefaultJnapErrHandler:true,disableDefaultAjaxErrHandler:true,disableDefaultRebootErrHandler:true,useAdminAuth:true,adminPasswordOverride:"Basic "+window.btoa("admin:"+$.trim(n)),forceLocal:true})})}else{window.location.replace("/ui/dynamic/welcome.html")}}else{RAINIER.network.setRemoteSetting(true,function(){if(typeof g==="function"){g()}else{RAINIER.shared.ui.authenticatedGoToIndex(k)}})}})},cbError:i})},mfa:c}}());